<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡πâ‡∏≤‡∏ô ‚Äî Login-only (No Signup) + Admin Gate</title>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script defer src="./lib/supabase.min.js"></script>
  <style>
  .analysis-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 8px;
      font-size: 14px;
    }
    .analysis-value {
      font-weight: 700;
      color: #667eea;
    }
    .verdict {
      text-align: center;
      margin-top: 10px;
      padding: 6px;
      border-radius: 8px;
      font-weight: 700;
      color: #fff;
    }
    .verdict-good { background-color: #20bf6b; }
    .verdict-ok { background-color: #f0932b; }
    .verdict-bad { background-color: #ff6b6b; }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
    .container{max-width:1200px;margin:0 auto}
    .header{color:#fff;text-align:center;margin-bottom:18px}
    .header h1{font-size:2.2rem;margin-bottom:6px;text-shadow:2px 2px 4px rgba(0,0,0,.25)}
    .card{background:rgba(255,255,255,.96);border-radius:20px;padding:22px;box-shadow:0 15px 35px rgba(0,0,0,.1);border:1px solid rgba(255,255,255,.2)}
    .blur{background:rgba(255,255,255,.12);backdrop-filter: blur(8px); border:1px solid rgba(255,255,255,.25);color:#fff}
    .main-grid{display:grid;grid-template-columns:1fr 1fr;gap:22px}
    .full{grid-column:1/-1}
    .input-group{margin-bottom:14px}
    .input-group label{display:block;margin-bottom:6px;color:#444;font-weight:600}
    .input-group input,.input-group select{width:100%;padding:12px;border:2px solid #e1e5e9;border-radius:10px;font-size:16px}
    .btn{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;padding:12px 18px;border-radius:10px;font-weight:700;cursor:pointer}
    .btn.block{width:100%}
    .btn-secondary{background:linear-gradient(135deg,#20bf6b 0%,#01a3a4 100%);color:#fff;border:none;padding:10px 16px;border-radius:8px;font-weight:700;cursor:pointer}
    .btn-danger{background:linear-gradient(135deg,#ff6b6b 0%,#ee5a52 100%)}
    .export-section{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .results-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:10px}
    .result-item{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);color:#fff;border-radius:15px;padding:18px;text-align:center}
    .result-item .value{font-size:1.4rem;font-weight:800}
    .chart-container{position:relative;height:300px;margin-top:14px}
    .bank-comparison{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;margin-top:12px}
    .bank-card{background:#fff;border-radius:14px;padding:16px;border-left:5px solid #667eea;box-shadow:0 10px 24px rgba(0,0,0,.08)}
    .bank-name{font-weight:800;color:#333}
    .selected-promotion{display:inline-block;margin-top:4px;background:#f3f4f6;padding:2px 8px;border-radius:999px;font-size:12px;color:#666}
    .rate-year{display:flex;justify-content:space-between;font-size:14px}
    .amortization{width:100%;border-collapse:collapse;margin-top:10px}
    .amortization th,.amortization td{padding:10px;border-bottom:1px solid #e9ecef;text-align:right}
    .amortization thead{background:#667eea;color:#fff}
    .notice{background:#fff3cd;color:#8a6d3b;border:1px solid #ffeaa7;padding:12px;border-radius:10px;margin-top:8px}
    .login-grid{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:end}
    .welcome{display:flex;justify-content:space-between;align-items:center;gap:10px}
    @media (max-width:900px){.main-grid{grid-template-columns:1fr}.login-grid{grid-template-columns:1fr}.welcome{flex-direction:column;align-items:flex-start}}
    .spinner-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;background:rgba(0,0,0,.15);backdrop-filter:blur(2px);z-index:9999}
    .spinner{width:48px;height:48px;border-radius:50%;border:4px solid #fff;border-top-color:#667eea;animation:spin 1s linear infinite}
    .spinner-label{color:#fff;margin-top:10px;font-weight:700;text-shadow:0 1px 2px rgba(0,0,0,.25)}
    @keyframes spin{to{transform:rotate(360deg)}}
    #toastContainer{position:fixed;top:16px;right:16px;z-index:10000;display:flex;flex-direction:column;gap:10px}
    .toast{opacity:0;transform:translateY(-8px);transition:all .25s ease;padding:10px 14px;border-radius:10px;color:#fff;box-shadow:0 8px 20px rgba(0,0,0,.15)}
    .toast.show{opacity:1;transform:translateY(0)}
    .toast.hide{opacity:0;transform:translateY(-8px)}
    .toast.info{background:linear-gradient(135deg,#667eea,#764ba2)}
    .toast.success{background:linear-gradient(135deg,#20bf6b,#01a3a4)}
    .toast.error{background:linear-gradient(135deg,#ff6b6b,#ee5a52)}
  </style>
  <script>
    (function(){
      function loadScript(url){
        return new Promise((resolve,reject)=>{
          const s=document.createElement('script'); s.src=url; s.defer=true;
          s.onload=()=>resolve(true); s.onerror=()=>reject(new Error('fail '+url));
          document.head.appendChild(s);
        });
      }
      async function ensureSupabase(){
        if (window.supabase) return true;
        const cdns=[ './lib/supabase.min.js', './lib/supabase.min.js', './lib/supabase.min.js' ];
        for (const u of cdns){
          try{ await loadScript(u); if (window.supabase) return true; }catch(_){ }
        }
        try{
          const supa = await import('./lib/supabase.min.js');
          window.supabase = supa; return true;
        }catch(e){ console.warn('ESM fallback failed:', e); }
        return !!window.supabase;
      }
      function enableLoginIfReady(){
        const btn=document.getElementById('loginBtn')||document.getElementById('loginButton');
        if(!btn) return; if(window.supabase){ btn.disabled=false; btn.textContent='‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'; }
      }
      window.addEventListener('DOMContentLoaded', ()=>{
        setTimeout(async ()=>{ await ensureSupabase(); enableLoginIfReady(); }, 500);
      });
    })();
  </script>
  <script>
    (function(){
      function setBtn(ready,msgReady='‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö',msgWait='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö...'){
        const btn=document.getElementById('loginBtn')||document.getElementById('loginButton');
        if(!btn) return; btn.disabled=!ready; btn.textContent=ready?msgReady:msgWait;
      }
      async function ensureSupabaseLocal(){
        if (window.supabase) return true;
        const urls=['./lib/supabase.min.js','../lib/supabase.min.js','/supabase.min.js','./supabase.min.js'];
        for(const u of urls){
          try{ await new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=u; s.defer=true; s.onload=()=>res(true); s.onerror=()=>rej(); document.head.appendChild(s); }); if(window.supabase) return true; }catch(_){ }
        }
        return false;
      }
      window.addEventListener('DOMContentLoaded', async ()=>{ setBtn(false); const ok=await ensureSupabaseLocal(); setBtn(!!ok, ok?'‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö':'‡πÑ‡∏°‡πà‡∏û‡∏ö ./lib/supabase.min.js'); });
      window.__ensureSupabaseLocal = ensureSupabaseLocal;
    })();
  </script>
</head>
<body>
  <div class="container">
    <div class="card blur" style="margin-bottom:14px">
      <div id="loginArea">
        <form id="loginForm" class="login-grid" onsubmit="event.preventDefault(); login();" autocomplete="on">
          <div class="input-group" style="margin:0"> <label style="color:#fff">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label> <input id="email" name="email" type="email" placeholder="admin@yourbank.com" required autocomplete="username email" autocapitalize="none" spellcheck="false" inputmode="email" /> </div>
          <div class="input-group" style="margin:0"> <label style="color:#fff">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label> <input id="password" name="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="current-password" /> </div>
          <button class="btn" id="loginBtn" type="submit" disabled>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </form>
        <div id="libStatus" style="margin-top:8px;background:#fff3cd;color:#8a6d3b;border:1px solid #ffeaa7;padding:8px 10px;border-radius:8px">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ Supabase...</div>
        <div id="loginError" style="display:none;margin-top:8px;background:#ff6b6b99;padding:8px 10px;border-radius:8px">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</div>
        <div style="margin-top:6px;font-size:12px;opacity:.9">* ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ‚Äî ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ô Supabase ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div>
      </div>
      <div id="userArea" class="welcome" style="display:none">
        <div>
          <div style="font-weight:700">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö <span id="who"></span></div>
          <div id="roleBadge" style="font-size:12px;opacity:.9"></div>
        </div>
        <div style="display:flex;gap:10px"> <button class="btn-secondary" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button> <button class="btn-secondary" onclick="refreshPromos()">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÇ‡∏õ‡∏£</button> </div>
      </div>
    </div>
    <div class="header">
      <h1>üè† ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡πâ‡∏≤‡∏ô</h1>
      <div>Login-only + Admin Gate ‚Äî ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡πÄ‡∏´‡πá‡∏ô/‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡πÅ‡∏Å‡πâ‡πÇ‡∏õ‡∏£‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin</div>
    </div>
<div class="main-grid" style="grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));">
      <div class="card">
        <h2>üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠</h2>
        <div class="input-group"><label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô (‡∏ö‡∏≤‡∏ó)</label><input id="housePrice" type="number" value="5000000"></div>
		<button class="btn block" onclick="calculateLoan()">üîç ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠</button>
        <div class="export-section"> <button class="btn-secondary" onclick="saveLoanLocal()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ)</button> <button class="btn-secondary" onclick="exportToPDF()">üìÑ Export PDF</button> <button class="btn-secondary" onclick="refreshPromos()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÇ‡∏õ‡∏£‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô</button> </div>
        <div id="debtNotice" class="notice" style="display:none"></div>
      </div>
      <div class="card">
        <h2>üí∞ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢)</h2>
        <div class="results-grid">
          <div class="result-item"><div>‡∏¢‡∏≠‡∏î‡∏Å‡∏π‡πâ‡∏¢‡∏∑‡∏°</div><div id="loanAmount" class="value">-</div></div>
          <div class="result-item"><div>‡∏ú‡πà‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div><div id="monthlyPayment" class="value">-</div></div>
        </div>
        <div class="chart-container"><canvas id="paymentChart"></canvas></div>
      </div>
    </div>
	
	<div class="card">
        <h2>üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏Å‡∏π‡πâ</h2>
        <div class="input-group">
          <label>‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ)</label>
          <input id="borrowerAge" type="number" value="30">
        </div>
        <div class="input-group">
          <label>‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</label>
          <input id="borrowerSalary" type="number" value="50000">
        </div>
        <div class="input-group">
          <label>‡πÇ‡∏ö‡∏ô‡∏±‡∏™ (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏õ‡∏µ)</label>
          <input id="borrowerBonus" type="number" value="50000">
        </div>
        <div class="input-group">
          <label>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</label>
          <input id="borrowerOtherIncome" type="number" value="0">
        </div>
        <div class="input-group">
          <label>‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡πÉ‡∏ô‡∏ö‡∏π‡πÇ‡∏£ (‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</label>
          <input id="borrowerDebt" type="number" value="5000">
        </div>
      </div>
 	
    <div class="card full">
      <h2>üè¶ ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</h2>
      <div id="promoStatus" class="notice" style="display:none"></div>
      <div id="bankComparison" class="bank-comparison"></div>
      <div id="rateUpdateTime" style="text-align:center;color:#666;margin-top:6px"></div>
    </div>

<div class="card full" id="promoAdmin" style="display:none">
      <h2>üõ†Ô∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡πÇ‡∏õ‡∏£‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ (Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)</h2>
      <div class="input-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</label><input id="bankNameInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢"/></div>
      <div class="input-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô</label><input id="promoNameInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©"/></div>
      
      <div class="input-group">
        <label>‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢</label>
        <div id="fixedRatesContainer"></div>
        <button type="button" class="btn-secondary" onclick="addFixedRateYear()" style="margin-top: 6px; padding: 6px 10px; font-size: 12px;">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏£‡∏≤‡∏¢‡∏õ‡∏µ (‡∏Ñ‡∏á‡∏ó‡∏µ‡πà)</button>
        <hr style="margin: 16px 0;">
        <label style="font-weight: 600; margin-top: 8px;">‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏µ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (‡∏´‡∏•‡∏±‡∏á‡∏´‡∏°‡∏î‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡∏á‡∏ó‡∏µ‡πà)</label>
        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 10px; align-items: center;">
          <input id="mrrRateInput" type="number" step="0.01" placeholder="‡πÄ‡∏ä‡πà‡∏ô 5.31">
          <input id="mrrDescInput" type="text" value="MRR - X.XX%" placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ ‡πÄ‡∏ä‡πà‡∏ô MRR - 5.31%">
        </div>
      </div>

      <div class="input-group"><label>‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</label><input id="conditionsInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡∏à‡∏≥"/></div>
      
      <div class="input-group">
        <label>‡∏≠‡∏≤‡∏¢‡∏∏‡∏ú‡∏π‡πâ‡∏Å‡∏π‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î (‡∏õ‡∏µ)</label>
        <input id="maxLoanAgeInput" type="number" placeholder="‡πÄ‡∏ä‡πà‡∏ô 65 ‡∏´‡∏£‡∏∑‡∏≠ 70 (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ ‡∏à‡∏∞‡πÉ‡∏ä‡πâ 65)">
      </div>
      <div class="input-group"><label>‡∏™‡∏µ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ï‡πå (Hex)</label><input id="colorInput" value="#667eea"/></div>
      <input type="hidden" id="promoIdInput"/>
      <div class="export-section">
        <button class="btn-secondary" onclick="savePromotion()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏õ‡∏£</button>
        <button class="btn-secondary btn-danger" onclick="clearPromoForm()">üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
      </div>
      <div style="margin-top:14px">
        <h3 style="text-align:center;margin-bottom:8px">‡πÇ‡∏õ‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö ‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin)</h3>
        <div id="myPromoList"></div>
      </div>
    </div>

    <div class="card full">
      <h2>üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ (12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏£‡∏Å)</h2>
      <table class="amortization">
        <thead><tr><th width="10%">‡∏á‡∏ß‡∏î</th><th width="22%">‡∏¢‡∏≠‡∏î‡∏ú‡πà‡∏≠‡∏ô</th><th width="22%">‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô</th><th width="22%">‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢</th><th width="24%">‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th></tr></thead>
        <tbody id="amortizationTable"></tbody>
      </table>
    </div>
  </div>
  <div id="toastContainer"></div>
  <div id="globalSpinner" class="spinner-overlay" role="status" aria-live="polite" aria-label="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô">
    <div class="spinner"></div>
    <div class="spinner-label">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...</div>
  </div>

  <script>
    // ===== Config =====
    const SUPABASE_URL = 'https://crgyqlfotaceyvoxatnq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNyZ3lxbGZvdGFjZXl2b3hhdG5xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5ODg5NzAsImV4cCI6MjA3MjU2NDk3MH0.pvSRkwkkCQNyRuG-cFadLTQjL6Cf73d4Nu7ur3YSn2U';
    const USE_SUPABASE = true;

    var supabaseClient = null;
    var promoByBank = {};

    let currentUser = null;
    let isAdmin = false;

    // ===== Utils =====
    const fmt = n => new Intl.NumberFormat('th-TH').format(Math.round(n||0));
    let doughnut = null;
	
	// ===== NEW: Functions for dynamic form =====
    function addFixedRateYear(year = '', rate = '') {
      const container = document.getElementById('fixedRatesContainer');
      const rateDiv = document.createElement('div');
      rateDiv.className = 'fixed-rate-row';
      rateDiv.style.display = 'grid';
      rateDiv.style.gridTemplateColumns = '1fr 1fr auto';
      rateDiv.style.gap = '10px';
      rateDiv.style.marginBottom = '8px';
      
      rateDiv.innerHTML = `
        <input type="number" class="fixed-rate-year-input" placeholder="‡∏õ‡∏µ‡∏ó‡∏µ‡πà" value="${year}">
        <input type="number" step="0.01" class="fixed-rate-rate-input" placeholder="‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ %" value="${rate}">
        <button type="button" class="btn-danger" onclick="this.parentElement.remove()" style="padding: 6px 10px;">‡∏•‡∏ö</button>
      `;
      container.appendChild(rateDiv);
    }


    function setLibUIReady(ready){
      const btn=document.getElementById('loginBtn');
      const bar=document.getElementById('libStatus');
      if(!btn||!bar) return;
      if(ready){
        btn.disabled=false;
        bar.style.background='#d4edda'; bar.style.color='#155724'; bar.style.border='1px solid #c3e6cb';
        bar.textContent='‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‚úÖ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ';
      }else{
        btn.disabled=true;
        bar.style.background='#fff3cd'; bar.style.color='#8a6d3b'; bar.style.border='1px solid #ffeaa7';
        bar.textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ Supabase...';
      }
    }

    function initSupabase(){
      try{
        if (USE_SUPABASE && !supabaseClient && window.supabase) {
          supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        }
      }catch(e){ console.error('Supabase init error:', e); }
    }
    
    function waitForSupabase(timeout=8000){
      const start=Date.now();
      if (!window.supabase && window.__ensureSupabaseLocal) { window.__ensureSupabaseLocal(); }
      return new Promise(resolve=>{
        (function tick(){
          if (window.supabase || (Date.now()-start)>timeout){ if(typeof setLibUIReady==='function') setLibUIReady(!!window.supabase); return resolve(!!window.supabase); }
          requestAnimationFrame(tick);
        })();
      });
    }

    // ===== ‡∏¢‡πâ‡∏≤‡∏¢‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô helpers ‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ =====
    function showSpinner(text='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...'){
      const ov=document.getElementById('globalSpinner'); if(!ov) return;
      ov.style.display='flex';
      const lab=ov.querySelector('.spinner-label'); if(lab) lab.textContent=text;
    }
    function hideSpinner(){ const ov=document.getElementById('globalSpinner'); if(ov) ov.style.display='none'; }
    function toast(message,type='info'){
      const cont=document.getElementById('toastContainer'); if(!cont) return;
      const el=document.createElement('div'); el.className=`toast ${type}`; el.textContent=message; cont.appendChild(el);
      requestAnimationFrame(()=> el.classList.add('show'));
      setTimeout(()=>{ el.classList.remove('show'); el.classList.add('hide'); }, 2500);
      setTimeout(()=> el.remove(), 3000);
    }

    // ===== Auth (Login-only) =====
    async function login(){
      if(!supabaseClient){ initSupabase(); if(!supabaseClient){ showLoginError('‡∏¢‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à'); return; }}
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      if(!email || !password){ showLoginError('‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô'); return; }
      try{
        showSpinner('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...');
        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if(error) throw error;
        currentUser = data.user; await determineAdmin(); updateAuthUI(true); await fetchPromotions();
        toast('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','success');
      }catch(e){ 
        toast('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error'); 
        showLoginError(e.message==='Invalid login credentials' ? '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á' : ('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: '+e.message)); 
      }
      finally{ hideSpinner(); }
    }

    function showLoginError(msg){ const err=document.getElementById('loginError'); err.textContent=msg; err.style.display='block'; }

    async function determineAdmin(){
      try{
        const { data, error } = await supabaseClient.from('user_roles').select('role').eq('user_id', currentUser.id).maybeSingle();
        if(error) throw error; isAdmin = (data && (data.role||'').toLowerCase()==='admin');
      }catch(e){ console.warn('‡∏ï‡∏£‡∏ß‡∏à‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:', e); isAdmin=false; }
    }

    async function logout(){ try{ await supabaseClient.auth.signOut(); }catch(e){} currentUser=null; isAdmin=false; updateAuthUI(false); }

    function updateAuthUI(loggedIn){
      const loginArea = document.getElementById('loginArea');
      const userArea  = document.getElementById('userArea');
      const who = document.getElementById('who');
      const badge = document.getElementById('roleBadge');
      const adminPane = document.getElementById('promoAdmin');
      if(loggedIn && currentUser){
        loginArea.style.display='none'; userArea.style.display='flex';
        who.textContent = currentUser.email; badge.textContent = isAdmin ? '‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: ADMIN' : '‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: USER';
        adminPane.style.display = isAdmin ? 'block' : 'none';
      } else {
        loginArea.style.display='block'; userArea.style.display='none'; adminPane.style.display='none';
      }
      const pwd=document.getElementById('password'); if(pwd) pwd.value='';
    }

    // ===== Calculations =====
    function calcMonthly(principal, annual, years){ const r=(annual/100)/12; const n=years*12; if(r===0) return principal/n; return principal*r*Math.pow(1+r,n)/(Math.pow(1+r,n)-1); }

// ===== NEW: Helper function to get best 3-year average rate from all promos =====
    function getBestPromoRate() {
      let bestRate = 100; // Start with a high number
      if (!promoByBank || Object.keys(promoByBank).length === 0) return 3.5; // Default rate if no promos

      Object.values(promoByBank).flat().forEach(promo => {
        const rates = promo.rates || [];
        if (rates.length > 0) {
          let totalRate = 0;
          for (let year = 1; year <= 3; year++) {
            let yearRate = rates[rates.length - 1].rate; // Default to last known rate
            for (const r of rates) {
              if (year <= r.year) {
                yearRate = r.rate;
                break;
              }
            }
            totalRate += yearRate;
          }
          const avgRate = totalRate / 3;
          if (avgRate < bestRate) {
            bestRate = avgRate;
          }
        }
      });
      return bestRate === 100 ? 3.5 : bestRate;
    }

    // ===== NEW: Helper function to calculate max loan from a monthly payment =====
    function calculateMaxLoan(monthlyPayment, annualRate, years) {
      const r = (annualRate / 100) / 12;
      const n = years * 12;
      if (r === 0) return monthlyPayment * n;
      return monthlyPayment * (Math.pow(1 + r, n) - 1) / (r * Math.pow(1 + r, n));
    }


    function calcTiered(principal, tiers, years){ const n=years*12; let bal=principal; let totI=0; const avg=tiers.reduce((a,t)=>a+t.rate,0)/Math.max(1,tiers.length); const pay=calcMonthly(principal, avg||0, years); for(let m=1;m<=n;m++){ const yr=Math.ceil(m/12); let ra=tiers.length?tiers[tiers.length-1].rate:0; for(const t of tiers){ if(yr<=t.year){ ra=t.rate; break; } } const mr=ra/100/12; const i=bal*mr; totI+=i; const p=pay-i; bal-=p; if(bal<=0) break; } return { monthly: pay, interest: totI }; }

 function calculateLoan() {
      // --- Get Base Data ---
      const housePrice = +document.getElementById('housePrice').value || 0;
      const age = +document.getElementById('borrowerAge').value || 0;
      
      // --- Calculate Max Possible Loan Term ---
      const MAX_LOAN_AGE = 65; // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà 65 ‡∏õ‡∏µ
      const MAX_LOAN_YEARS = 35; // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏ú‡πà‡∏≠‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà 35 ‡∏õ‡∏µ
const maxYears = Math.max(1, MAX_LOAN_AGE - age);

      const salary = +document.getElementById('borrowerSalary').value || 0;
      const bonus = +document.getElementById('borrowerBonus').value || 0;
      const otherIncome = +document.getElementById('borrowerOtherIncome').value || 0;
      const existingDebt = +document.getElementById('borrowerDebt').value || 0;
      const totalMonthlyIncome = salary + (bonus / 12) + otherIncome;

      // --- Smart Calculation Logic ---
      const bestRate = getBestPromoRate();
      let loanAmount = housePrice;
      let monthlyPayment = calcMonthly(loanAmount, bestRate, maxYears);
      let totalMonthlyDebt = monthlyPayment + existingDebt;
      let dsr = totalMonthlyIncome > 0 ? (totalMonthlyDebt / totalMonthlyIncome) * 100 : 101;
      
      let requiredDownPayment = 0;
      const DSR_CEILING = 55;

      if (dsr > DSR_CEILING) {
        const maxAffordablePayment = (totalMonthlyIncome * (DSR_CEILING / 100)) - existingDebt;
        if (maxAffordablePayment > 0) {
          loanAmount = calculateMaxLoan(maxAffordablePayment, bestRate, maxYears);
          monthlyPayment = maxAffordablePayment;
        } else {
          loanAmount = 0;
          monthlyPayment = 0;
        }
        requiredDownPayment = housePrice - loanAmount;
      }
      
      // --- Update UI ---
      document.getElementById('loanAmount').textContent = fmt(loanAmount) + ' ‡∏ö‡∏≤‡∏ó';
      document.getElementById('monthlyPayment').textContent = fmt(monthlyPayment) + ' ‡∏ö‡∏≤‡∏ó';

      const note = document.getElementById('debtNotice');
      note.style.display = 'block';

      if (requiredDownPayment > 0) {
        const downPercent = housePrice > 0 ? (requiredDownPayment / housePrice) * 100 : 0;
        note.innerHTML = `üö® ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡πÑ‡∏°‡πà‡∏û‡∏≠ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ ${maxYears} ‡∏õ‡∏µ)<br>
                          <strong>‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢: ${fmt(requiredDownPayment)} ‡∏ö‡∏≤‡∏ó (${downPercent.toFixed(1)}%)</strong>`;
      } else {
        dsr = totalMonthlyIncome > 0 ? ((monthlyPayment + existingDebt) / totalMonthlyIncome) * 100 : 0;
        note.textContent = `‚úÖ DSR ~ ${dsr.toFixed(1)}% (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ ${maxYears} ‡∏õ‡∏µ)`;
      }

      // Re-render other components, passing age instead of years
      buildChart(loanAmount, (monthlyPayment * maxYears * 12) - loanAmount);
      buildAmort(loanAmount, bestRate, maxYears, monthlyPayment);
      compareBanks(loanAmount, age); // **‡∏™‡πà‡∏á "‡∏≠‡∏≤‡∏¢‡∏∏" ‡πÑ‡∏õ‡πÅ‡∏ó‡∏ô "‡∏õ‡∏µ"**
    }

    function compareBanks(loanAmount, borrowerAge) {
      const box = document.getElementById('bankComparison');
      if (!box) return;
      box.innerHTML = '';

      const salary = +document.getElementById('borrowerSalary').value || 0;
      const bonus = +document.getElementById('borrowerBonus').value || 0;
      const otherIncome = +document.getElementById('borrowerOtherIncome').value || 0;
      const existingDebt = +document.getElementById('borrowerDebt').value || 0;
      const totalMonthlyIncome = salary + (bonus / 12) + otherIncome;

      const data = promoByBank || {};
      if (Object.keys(data).length === 0) {
        box.innerHTML = '<p style="text-align:center; color:#666; grid-column: 1 / -1;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô</p>';
        return;
      }

      Object.keys(data).forEach(bank => {
        const promos = data[bank];
        (promos || []).forEach(promo => {
          
          // --- NEW: DYNAMIC LOAN TERM CALCULATION PER PROMO ---
          const MAX_LOAN_AGE = 65;
          const MAX_LOAN_YEARS = 35;
          const years = Math.max(1, Math.min(MAX_LOAN_YEARS, MAX_LOAN_AGE - borrowerAge));
          // --- END DYNAMIC CALCULATION ---

          const c = calcTiered(loanAmount, promo.rates || [], years);
          const card = document.createElement('div');
          card.className = 'bank-card';
          card.style.borderLeftColor = promo.color || '#667eea';

          let analysisHtml = '';
          if (totalMonthlyIncome > 0) {
            const totalMonthlyDebtWithThisPromo = c.monthly + existingDebt;
            const dsr = (totalMonthlyDebtWithThisPromo / totalMonthlyIncome) * 100;
            
            const maxAffordablePayment = (totalMonthlyIncome * 0.50) - existingDebt;
            const estimatedMaxLoan = maxAffordablePayment > 0 ? calculateMaxLoan(maxAffordablePayment, (promo.rates[0]?.rate || 3), years) : 0;

            let verdict = '';
            let verdictClass = '';
            if (dsr <= 40) { verdict = '‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥'; verdictClass = 'verdict-good'; } 
            else if (dsr <= 55) { verdict = '‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ'; verdictClass = 'verdict-ok'; } 
            else { verdict = '‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á'; verdictClass = 'verdict-bad'; }

            analysisHtml = `
              <hr style="margin: 10px 0;">
              <div class="analysis-grid">
                  <div><strong>DSR ‡∏Å‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡∏ô‡∏µ‡πâ:</strong><br><span class="analysis-value">${dsr.toFixed(1)}%</span></div>
                  <div><strong>‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì):</strong><br><span class="analysis-value">${fmt(estimatedMaxLoan)}</span></div>
              </div>
              <div class="verdict ${verdictClass}">${verdict}</div>
            `;
          }

          card.innerHTML = `
            <div class="bank-name">${bank}</div>
            <div class="selected-promotion">${promo.name}</div>
            <div style="margin-top:8px; font-weight: bold; color: #333;">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏π‡πâ: ${years} ‡∏õ‡∏µ (‡∏ú‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡∏ñ‡∏∂‡∏á‡∏≠‡∏≤‡∏¢‡∏∏ ${maxLoanAgeForPromo})</div>
            <div style="display:grid;grid-template-columns:1fr;gap:8px;margin-top:8px">
              <div><strong>‡∏ú‡πà‡∏≠‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</strong><br>${fmt(c.monthly)} ‡∏ö‡∏≤‡∏ó</div>
            </div>
            ${analysisHtml} 
          `;
          box.appendChild(card);
        });
      });
    }

    function buildChart(p,i){ const ctx=document.getElementById('paymentChart'); if(!ctx) return; if(doughnut) doughnut.destroy(); doughnut=new Chart(ctx,{type:'doughnut',data:{labels:['‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô','‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢'],datasets:[{data:[p,i],backgroundColor:['#667eea','#f093fb'],borderWidth:3,borderColor:'#fff'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom'}}}}); }
    function buildAmort(loan, rate, years, pay){ const tb=document.getElementById('amortizationTable'); tb.innerHTML=''; const mr=rate/100/12; let bal=loan; for(let m=1;m<=12;m++){ const i=bal*mr; const pr=pay-i; bal-=pr; const tr=document.createElement('tr'); tr.innerHTML=`<td style="text-align:center">${m}</td><td>${fmt(pay)}</td><td>${fmt(pr)}</td><td>${fmt(i)}</td><td>${fmt(Math.max(0,bal))}</td>`; tb.appendChild(tr);} }

    // ===== Promotions (Supabase) =====
    // ##### ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç SyntaxError ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ '\n' ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà #####
   
// ===== NEW: Replaces old parseRates and ratesToText functions =====
    function parseRatesFromForm() {
      const rates = [];
      // Get fixed rates
      document.querySelectorAll('.fixed-rate-row').forEach(row => {
        const year = parseInt(row.querySelector('.fixed-rate-year-input').value, 10);
        const rate = parseFloat(row.querySelector('.fixed-rate-rate-input').value);
        if (!isNaN(year) && !isNaN(rate)) {
          rates.push({ year, rate, description: '‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏Ñ‡∏á‡∏ó‡∏µ‡πà' });
        }
      });

      // Get MRR rate for subsequent years
      const mrrRateValue = parseFloat(document.getElementById('mrrRateInput').value);
      const mrrDesc = document.getElementById('mrrDescInput').value.trim();
      if (!isNaN(mrrRateValue) && mrrDesc) {
        // We use a conventional high number for year to represent "all subsequent years"
        // Our calculation logic will correctly pick this up as the last tier.
        const effectiveRate = 6.87 - mrrRateValue; // Assuming current MRR is 6.87, adjust if needed
        rates.push({ year: 99, rate: effectiveRate, description: mrrDesc });
      }

      // Sort by year to ensure correct calculation order
      return rates.sort((a, b) => a.year - b.year);
    }

    function populateFormWithRates(rates = []) {
      // Clear existing fields first
      document.getElementById('fixedRatesContainer').innerHTML = '';
      document.getElementById('mrrRateInput').value = '';
      document.getElementById('mrrDescInput').value = 'MRR - X.XX%';

      rates.forEach(rate => {
        if (rate.year === 99) { // This is our MRR rate convention
           const mrrValueMatch = (rate.description || '').match(/MRR\s*-\s*([0-9.]+)/i);
           const mrrValue = mrrValueMatch ? mrrValueMatch[1] : '';
           document.getElementById('mrrRateInput').value = mrrValue;
           document.getElementById('mrrDescInput').value = rate.description;
        } else { // This is a fixed rate
          addFixedRateYear(rate.year, rate.rate);
        }
      });
    }
    
    // Override the old clearPromoForm
    function clearPromoForm() {
      document.getElementById('promoIdInput').value = '';
      document.getElementById('bankNameInput').value = '';
      document.getElementById('promoNameInput').value = '';
      document.getElementById('conditionsInput').value = '';
	  document.getElementById('maxLoanAgeInput').value = '';
      document.getElementById('colorInput').value = '#667eea';
      // New part to clear the dynamic form
      populateFormWithRates([]);
    }

// ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß
async function fetchPromotions(){
  if(!supabaseClient) return;
  try{
        const { data, error } = await supabaseClient.from('bank_promotions').select('id,bank_name,name,rates,conditions,color,max_loan_age').order('bank_name',{ascending:true}).order('created_at',{ascending:false});
    if(error) throw error;
    const g={}; (data||[]).forEach(row=>{ (g[row.bank_name]=g[row.bank_name]||[]).push({id:row.id,name:row.name,rates:row.rates||[],conditions:row.conditions||'',color:row.color||'#667eea'}); });
        promoByBank=g; 
        renderPromoList(); 
    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ "‡∏≠‡∏≤‡∏¢‡∏∏" ‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡πÅ‡∏ó‡∏ô
        const currentAge = +document.getElementById('borrowerAge').value;
        compareBanks(getCurrentLoanAmount(), currentAge); 
        document.getElementById('rateUpdateTime').textContent=`‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${new Date().toLocaleString('th-TH')}`;
      }catch(e){ console.error(e); showStatus('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡πÇ‡∏õ‡∏£‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', true); }
}

function getCurrentLoanAmount() {
  // Return the full house price because down payment is now calculated dynamically.
  return +document.getElementById('housePrice').value || 0;
} 
	function showStatus(msg,isErr=false){
      const el=document.getElementById('promoStatus');
      if(el){ el.style.display='block'; el.textContent=(isErr?'‚ùå ':'‚úÖ ')+msg; setTimeout(()=>{el.style.display='none'},3000); }
      toast(msg, isErr?'error':'success');
    }

async function savePromotion() {
      if (!isAdmin) {
        alert('‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Admin) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
        return;
      }
      const id = (document.getElementById('promoIdInput').value || '').trim();
      const bank = (document.getElementById('bankNameInput').value || '').trim();
      const name = (document.getElementById('promoNameInput').value || '').trim();
      const rates = parseRatesFromForm();
      const conditions = (document.getElementById('conditionsInput').value || '').trim();
      const color = (document.getElementById('colorInput').value || '#667eea').trim();
      // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏¢‡∏∏‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏° (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏Å ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ 65)
      const max_loan_age = parseInt(document.getElementById('maxLoanAgeInput').value, 10) || 65;

      if (!bank || !name || rates.length === 0) {
        alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£/‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£ + ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î');
        return;
      }
      
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á object ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
      const promoData = { bank_name: bank, name, rates, conditions, color, max_loan_age };

      try {
        if (id) {
          const { error } = await supabaseClient.from('bank_promotions').update(promoData).eq('id', id);
          if (error) throw error;
          showStatus('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏õ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        } else {
          const { error } = await supabaseClient.from('bank_promotions').insert([{ ...promoData, is_public: true }]);
          if (error) throw error;
          showStatus('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏õ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        }
        clearPromoForm();
        await fetchPromotions();
      } catch (e) {
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message);
      }
    }
 
    function renderPromoList(){ 
	const h=document.getElementById('myPromoList'); 
	if(!h) return; const flat=[]; 
	Object.keys(promoByBank||{}).forEach(b=>{ (promoByBank[b]||[]).forEach(p=>flat.push({bank:b,...p})) }); 
	if(flat.length===0){ h.innerHTML='<p style="text-align:center;color:#666">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>'; 
	return; 
	} 
	h.innerHTML=flat.map(p=>`<div style="padding:10px;border:1px solid #e9ecef;border-radius:10px;margin:6px 0;"><div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${p.bank}</strong> ‚Äî ${p.name}</div>${isAdmin?`<div style="display:flex;gap:6px"><button class="btn-secondary" style="padding:6px 10px;font-size:12px" onclick='editPromotion(${JSON.stringify({bank: p.bank, ...p})})'>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button><button class="btn-danger" style="padding:6px 10px;font-size:12px" onclick="deletePromotion('${p.id}')">‡∏•‡∏ö</button></div>`:''}</div><div style="font-size:12px;color:#555;margin-top:4px">${p.conditions||''}</div><div style="font-size:12px;margin-top:6px">${(p.rates||[]).map(r=>`‡∏õ‡∏µ‡∏ó‡∏µ‡πà ${r.year}: ${r.rate}% <span style=\"color:#6c757d\">${r.description||''}</span>`).join('<br>')}</div></div>`).join(''); 
	document.getElementById('promoAdmin').style.display=isAdmin?'block':'none'; }

    function editPromotion(p) {
	if(!isAdmin) return; 
      document.getElementById('promoIdInput').value = p.id || '';
      document.getElementById('bankNameInput').value = p.bank || '';
	document.getElementById('promoNameInput').value=p.name||''; 
	
      populateFormWithRates(p.rates || []);

      document.getElementById('conditionsInput').value = p.conditions || '';
		document.getElementById('maxLoanAgeInput').value = p.max_loan_age || '';

	document.getElementById('colorInput').value=p.color||'#667eea'; 
	window.scrollTo({top:document.getElementById('promoAdmin').offsetTop-10,behavior:'smooth'}); 
	}
    
	async function deletePromotion(id){ if(!isAdmin||!id||!confirm('‡∏•‡∏ö‡πÇ‡∏õ‡∏£‡∏ô‡∏µ‡πâ?')) return; try{ const { error } = await supabaseClient.from('bank_promotions').delete().eq('id',id); if(error) throw error; await fetchPromotions(); showStatus('‡∏•‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); }catch(e){ alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: '+e.message); } }

    function compareBanks(loanAmount, borrowerAge) {
      const box = document.getElementById('bankComparison');
      if (!box) return;
      box.innerHTML = '';

      // --- Get Borrower's Data for Analysis ---
      const salary = +document.getElementById('borrowerSalary').value || 0;
      const bonus = +document.getElementById('borrowerBonus').value || 0;
      const otherIncome = +document.getElementById('borrowerOtherIncome').value || 0;
      const existingDebt = +document.getElementById('borrowerDebt').value || 0;
      const totalMonthlyIncome = salary + (bonus / 12) + otherIncome;
      // --- End Borrower's Data ---

      const data = promoByBank || {};
      if (Object.keys(data).length === 0) {
        box.innerHTML = '<p style="text-align:center; color:#666; grid-column: 1 / -1;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô</p>';
        return;
      }

      Object.keys(data).forEach(bank => {
        const promos = data[bank];
        (promos || []).forEach(promo => {
		
          // --- DYNAMIC LOAN TERM CALCULATION PER PROMO ---
          // ‡πÉ‡∏ä‡πâ promo.max_loan_age ‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å DB
          const maxLoanAgeForPromo = promo.max_loan_age || 65; 
          const MAX_LOAN_YEARS = 35;
const years = Math.max(1, maxLoanAgeForPromo - borrowerAge);
          // --- END DYNAMIC CALCULATION ---

          const c = calcTiered(loanAmount, promo.rates || [], years);

		  
          const card = document.createElement('div');
          card.className = 'bank-card';
          card.style.borderLeftColor = promo.color || '#667eea';

          // --- NEW: Per-Promotion Analysis ---
          let analysisHtml = '';
          if (totalMonthlyIncome > 0) {
            const totalMonthlyDebtWithThisPromo = c.monthly + existingDebt;
            const dsr = (totalMonthlyDebtWithThisPromo / totalMonthlyIncome) * 100;
            
            // Max loan estimation based on this income and 50% DSR ceiling
            const maxAffordablePayment = (totalMonthlyIncome * 0.50) - existingDebt;
            const estimatedMaxLoan = maxAffordablePayment > 0 ? (maxAffordablePayment * (Math.pow(1 + ((promo.rates[0]?.rate || 3) / 100) / 12, years * 12) - 1)) / (((promo.rates[0]?.rate || 3) / 100) / 12 * Math.pow(1 + ((promo.rates[0]?.rate || 3) / 100) / 12, years * 12)) : 0;

            let verdict = '';
            let verdictClass = '';
            if (dsr <= 40) {
              verdict = '‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥';
              verdictClass = 'verdict-good';
            } else if (dsr <= 55) {
              verdict = '‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ';
              verdictClass = 'verdict-ok';
            } else {
              verdict = '‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á';
              verdictClass = 'verdict-bad';
            }

            analysisHtml = `
              <hr style="margin: 10px 0;">
              <div class="analysis-grid">
                  <div><strong>DSR ‡∏Å‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡∏ô‡∏µ‡πâ:</strong><br><span class="analysis-value">${dsr.toFixed(1)}%</span></div>
                  <div><strong>‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì):</strong><br><span class="analysis-value">${fmt(estimatedMaxLoan)}</span></div>
              </div>
              <div class="verdict ${verdictClass}">${verdict}</div>
            `;
          }
          // --- END: Per-Promotion Analysis ---

          card.innerHTML = `
            <div class="bank-name">${bank}</div>
            <div class="selected-promotion">${promo.name}</div>
            <div style="margin-top:8px; font-weight: bold; color: #333;">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏π‡πâ: ${years} ‡∏õ‡∏µ (‡∏ú‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡∏ñ‡∏∂‡∏á‡∏≠‡∏≤‡∏¢‡∏∏ ${maxLoanAgeForPromo})</div>
             <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:8px">
              <div><strong>‡∏ú‡πà‡∏≠‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</strong><br>${fmt(c.monthly)} ‡∏ö‡∏≤‡∏ó</div>
              <div><strong>‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏£‡∏ß‡∏°</strong><br>${fmt(c.interest)} ‡∏ö‡∏≤‡∏ó</div>
            </div>
            ${analysisHtml} 
          `;
          box.appendChild(card);
        });
      });
    }
	
function saveLoanLocal() {
    const item = {
        ts: Date.now(),
        house: +document.getElementById('housePrice').value || 0,
        borrower: {
            age: +document.getElementById('borrowerAge').value || 0,
            salary: +document.getElementById('borrowerSalary').value || 0
        },
        results: {
            loan: document.getElementById('loanAmount').textContent,
            pay: document.getElementById('monthlyPayment').textContent
        }
    };
	const arr=JSON.parse(localStorage.getItem('loan_saves')||'[]'); arr.unshift(item); localStorage.setItem('loan_saves', JSON.stringify(arr)); 
	showStatus('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß'); 
	}

    async function refreshPromos(){ showSpinner('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÇ‡∏õ‡∏£...'); await fetchPromotions(); hideSpinner(); }

    async function restoreSession(){ if(!supabaseClient) return; try{ const { data } = await supabaseClient.auth.getUser(); if(data && data.user){ currentUser=data.user; await determineAdmin(); updateAuthUI(true); } }catch(e){ console.warn('restoreSession:', e); } }

    async function start(){
      showSpinner('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ Supabase...');
      const ok = await waitForSupabase();
      if(!ok){ setLibUIReady(false); console.warn('Supabase library not loaded'); }
      initSupabase();
      if(supabaseClient){ setLibUIReady(true); toast('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Supabase ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô','success'); }
      hideSpinner();
      await restoreSession();
      calculateLoan();
      fetchPromotions();
      document.getElementById('rateUpdateTime').textContent=`‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${new Date().toLocaleString('th-TH')}`;

    ['housePrice', 'borrowerAge', 'borrowerSalary', 'borrowerBonus', 'borrowerOtherIncome', 'borrowerDebt'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('input', calculateLoan);
        }
    });

    }
    document.addEventListener('DOMContentLoaded', start);
  </script>

</body>
</html>