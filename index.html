<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡πâ‡∏≤‡∏ô ‚Äî Login-only (No Signup) + Admin Gate</title>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script defer src="./lib/supabase.min.js"></script>
  <style>
  .analysis-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 8px;
      font-size: 14px;
    }
    .analysis-value {
      font-weight: 700;
      color: #667eea;
    }
    .verdict {
      text-align: center;
      margin-top: 10px;
      padding: 6px;
      border-radius: 8px;
      font-weight: 700;
      color: #fff;
    }
    .verdict-good { background-color: #20bf6b; }
    .verdict-ok { background-color: #f0932b; }
    .verdict-bad { background-color: #ff6b6b; }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
    .container{max-width:1200px;margin:0 auto}
    .header{color:#fff;text-align:center;margin-bottom:18px}
    .header h1{font-size:2.2rem;margin-bottom:6px;text-shadow:2px 2px 4px rgba(0,0,0,.25)}
    .card{background:rgba(255,255,255,.96);border-radius:20px;padding:22px;box-shadow:0 15px 35px rgba(0,0,0,.1);border:1px solid rgba(255,255,255,.2)}
    .blur{background:rgba(255,255,255,.12);backdrop-filter: blur(8px); border:1px solid rgba(255,255,255,.25);color:#fff}
    .main-grid{display:grid;grid-template-columns:1fr 1fr;gap:22px}
    .full{grid-column:1/-1}
    .input-group{margin-bottom:14px}
    .input-group label{display:block;margin-bottom:6px;color:#444;font-weight:600}
    .input-group input,.input-group select{width:100%;padding:12px;border:2px solid #e1e5e9;border-radius:10px;font-size:16px}
    .btn{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;padding:12px 18px;border-radius:10px;font-weight:700;cursor:pointer}
    .btn.block{width:100%}
    .btn-secondary{background:linear-gradient(135deg,#20bf6b 0%,#01a3a4 100%);color:#fff;border:none;padding:10px 16px;border-radius:8px;font-weight:700;cursor:pointer}
    .btn-danger{background:linear-gradient(135deg,#ff6b6b 0%,#ee5a52 100%)}
    .export-section{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .results-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:10px}
    .result-item{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);color:#fff;border-radius:15px;padding:18px;text-align:center}
    .result-item .value{font-size:1.4rem;font-weight:800}
    .chart-container{position:relative;height:300px;margin-top:14px}
    .bank-comparison{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;margin-top:12px}
    .bank-card{background:#fff;border-radius:14px;padding:16px;border-left:5px solid #667eea;box-shadow:0 10px 24px rgba(0,0,0,.08)}
    .bank-name{font-weight:800;color:#333}
    .selected-promotion{display:inline-block;margin-top:4px;background:#f3f4f6;padding:2px 8px;border-radius:999px;font-size:12px;color:#666}
    .rate-year{display:flex;justify-content:space-between;font-size:14px}
    .amortization{width:100%;border-collapse:collapse;margin-top:10px}
    .amortization th,.amortization td{padding:10px;border-bottom:1px solid #e9ecef;text-align:right}
    .amortization thead{background:#667eea;color:#fff}
    .notice{background:#fff3cd;color:#8a6d3b;border:1px solid #ffeaa7;padding:12px;border-radius:10px;margin-top:8px}
    .login-grid{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:end}
    .welcome{display:flex;justify-content:space-between;align-items:center;gap:10px}
    @media (max-width:900px){.main-grid{grid-template-columns:1fr}.login-grid{grid-template-columns:1fr}.welcome{flex-direction:column;align-items:flex-start}}
    .spinner-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;background:rgba(0,0,0,.15);backdrop-filter:blur(2px);z-index:9999}
    .spinner{width:48px;height:48px;border-radius:50%;border:4px solid #fff;border-top-color:#667eea;animation:spin 1s linear infinite}
    .spinner-label{color:#fff;margin-top:10px;font-weight:700;text-shadow:0 1px 2px rgba(0,0,0,.25)}
    @keyframes spin{to{transform:rotate(360deg)}}
    #toastContainer{position:fixed;top:16px;right:16px;z-index:10000;display:flex;flex-direction:column;gap:10px}
    .toast{opacity:0;transform:translateY(-8px);transition:all .25s ease;padding:10px 14px;border-radius:10px;color:#fff;box-shadow:0 8px 20px rgba(0,0,0,.15)}
    .toast.show{opacity:1;transform:translateY(0)}
    .toast.hide{opacity:0;transform:translateY(-8px)}
    .toast.info{background:linear-gradient(135deg,#667eea,#764ba2)}
    .toast.success{background:linear-gradient(135deg,#20bf6b,#01a3a4)}
    .toast.error{background:linear-gradient(135deg,#ff6b6b,#ee5a52)}
  </style>
  <script>
    (function(){
      function loadScript(url){
        return new Promise((resolve,reject)=>{
          const s=document.createElement('script'); s.src=url; s.defer=true;
          s.onload=()=>resolve(true); s.onerror=()=>reject(new Error('fail '+url));
          document.head.appendChild(s);
        });
      }
      async function ensureSupabase(){
        if (window.supabase) return true;
        const cdns=[ './lib/supabase.min.js', './lib/supabase.min.js', './lib/supabase.min.js' ];
        for (const u of cdns){
          try{ await loadScript(u); if (window.supabase) return true; }catch(_){ }
        }
        try{
          const supa = await import('./lib/supabase.min.js');
          window.supabase = supa; return true;
        }catch(e){ console.warn('ESM fallback failed:', e); }
        return !!window.supabase;
      }
      function enableLoginIfReady(){
        const btn=document.getElementById('loginBtn')||document.getElementById('loginButton');
        if(!btn) return; if(window.supabase){ btn.disabled=false; btn.textContent='‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'; }
      }
      window.addEventListener('DOMContentLoaded', ()=>{
        setTimeout(async ()=>{ await ensureSupabase(); enableLoginIfReady(); }, 500);
      });
    })();
  </script>
  <script>
    (function(){
      function setBtn(ready,msgReady='‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö',msgWait='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö...'){
        const btn=document.getElementById('loginBtn')||document.getElementById('loginButton');
        if(!btn) return; btn.disabled=!ready; btn.textContent=ready?msgReady:msgWait;
      }
      async function ensureSupabaseLocal(){
        if (window.supabase) return true;
        const urls=['./lib/supabase.min.js','../lib/supabase.min.js','/supabase.min.js','./supabase.min.js'];
        for(const u of urls){
          try{ await new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=u; s.defer=true; s.onload=()=>res(true); s.onerror=()=>rej(); document.head.appendChild(s); }); if(window.supabase) return true; }catch(_){ }
        }
        return false;
      }
      window.addEventListener('DOMContentLoaded', async ()=>{ setBtn(false); const ok=await ensureSupabaseLocal(); setBtn(!!ok, ok?'‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö':'‡πÑ‡∏°‡πà‡∏û‡∏ö ./lib/supabase.min.js'); });
      window.__ensureSupabaseLocal = ensureSupabaseLocal;
    })();
  </script>
</head>
<body>
  <div class="container">
    <div class="card blur" style="margin-bottom:14px">
      <div id="loginArea">
        <form id="loginForm" class="login-grid" onsubmit="event.preventDefault(); login();" autocomplete="on">
          <div class="input-group" style="margin:0"> <label style="color:#fff">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label> <input id="email" name="email" type="email" placeholder="admin@yourbank.com" required autocomplete="username email" autocapitalize="none" spellcheck="false" inputmode="email" /> </div>
          <div class="input-group" style="margin:0"> <label style="color:#fff">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label> <input id="password" name="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="current-password" /> </div>
          <button class="btn" id="loginBtn" type="submit" disabled>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </form>
        <div id="libStatus" style="margin-top:8px;background:#fff3cd;color:#8a6d3b;border:1px solid #ffeaa7;padding:8px 10px;border-radius:8px">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ Supabase...</div>
        <div id="loginError" style="display:none;margin-top:8px;background:#ff6b6b99;padding:8px 10px;border-radius:8px">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</div>
        <div style="margin-top:6px;font-size:12px;opacity:.9">* ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ‚Äî ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ô Supabase ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div>
      </div>
      <div id="userArea" class="welcome" style="display:none">
        <div>
          <div style="font-weight:700">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö <span id="who"></span></div>
          <div id="roleBadge" style="font-size:12px;opacity:.9"></div>
        </div>
        <div style="display:flex;gap:10px"> <button class="btn-secondary" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button> <button class="btn-secondary" onclick="refreshPromos()">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÇ‡∏õ‡∏£</button> </div>
      </div>
    </div>
    <div class="header">
      <h1>üè† ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡πâ‡∏≤‡∏ô</h1>
      <div>Login-only + Admin Gate ‚Äî ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡πÄ‡∏´‡πá‡∏ô/‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡πÅ‡∏Å‡πâ‡πÇ‡∏õ‡∏£‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin</div>
    </div>
<div class="main-grid" style="grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));">
      <div class="card">
        <h2>üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠</h2>
        <div class="input-group"><label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô (‡∏ö‡∏≤‡∏ó)</label><input id="housePrice" type="number" value="5000000"></div>
		<button class="btn block" onclick="calculateLoan()">üîç ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠</button>
        <div class="export-section"> <button class="btn-secondary" onclick="saveLoanLocal()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ)</button> <button class="btn-secondary" onclick="exportToPDF()">üìÑ Export PDF</button> <button class="btn-secondary" onclick="refreshPromos()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÇ‡∏õ‡∏£‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô</button> </div>
        <div id="debtNotice" class="notice" style="display:none"></div>
      </div>
      <div class="card">
        <h2>üí∞ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢)</h2>
        <div class="results-grid">
          <div class="result-item"><div>‡∏¢‡∏≠‡∏î‡∏Å‡∏π‡πâ‡∏¢‡∏∑‡∏°</div><div id="loanAmount" class="value">-</div></div>
          <div class="result-item"><div>‡∏ú‡πà‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div><div id="monthlyPayment" class="value">-</div></div>
        </div>
        <div class="chart-container"><canvas id="paymentChart"></canvas></div>
      </div>
    </div>
	
	<div class="card">
        <h2>üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏Å‡∏π‡πâ</h2>
        <div class="input-group">
          <label>‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ)</label>
          <input id="borrowerAge" type="number" value="30">
        </div>
        <div class="input-group">
          <label>‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</label>
          <input id="borrowerSalary" type="number" value="50000">
        </div>
        <div class="input-group">
          <label>‡πÇ‡∏ö‡∏ô‡∏±‡∏™ (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏õ‡∏µ)</label>
          <input id="borrowerBonus" type="number" value="50000">
        </div>
        <div class="input-group">
          <label>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</label>
          <input id="borrowerOtherIncome" type="number" value="0">
        </div>
        <div class="input-group">
          <label>‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡πÉ‡∏ô‡∏ö‡∏π‡πÇ‡∏£ (‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</label>
          <input id="borrowerDebt" type="number" value="5000">
        </div>
      </div>
 	
    <div class="card full">
      <h2>üè¶ ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</h2>
      <div id="promoStatus" class="notice" style="display:none"></div>
      <div id="bankComparison" class="bank-comparison"></div>
      <div id="rateUpdateTime" style="text-align:center;color:#666;margin-top:6px"></div>
    </div>

<div class="card full" id="bankAdmin" style="display:none">
      <h2>üè¶ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÅ‡∏•‡∏∞ MRR</h2>
      <div class="input-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</label><input id="bankNameMasterInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û"/></div>
      <div class="input-group"><label>MRR ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (%)</label><input id="bankMrrMasterInput" type="number" step="0.01" placeholder="‡πÄ‡∏ä‡πà‡∏ô 7.30"/></div>
      <input type="hidden" id="bankIdInput"/>
      <div class="export-section">
        <button class="btn-secondary" onclick="saveBank()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</button>
        <button class="btn-secondary btn-danger" onclick="clearBankForm()">üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
      </div>
      <div style="margin-top:14px">
        <h3 style="text-align:center;margin-bottom:8px">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h3>
        <div id="bankMasterList"></div>
      </div>
    </div>

<div class="card full" id="promoAdmin" style="display:none">
      <h2>üõ†Ô∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡πÇ‡∏õ‡∏£‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ (Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)</h2>
      
      <div class="input-group">
        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</label>
        <select id="bankNameSelect" onchange="handleBankSelectionChange()">
          <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ --</option>
        </select>
      </div>
      
      <div class="input-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô</label><input id="promoNameInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©"/></div>
      
      <div class="input-group">
        <label>‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢</label>
        <div id="fixedRatesContainer"></div>
        <button type="button" class="btn-secondary" onclick="addFixedRateYear()" style="margin-top: 6px; padding: 6px 10px; font-size: 12px;">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏£‡∏≤‡∏¢‡∏õ‡∏µ (‡∏Ñ‡∏á‡∏ó‡∏µ‡πà)</button>
        
        <hr style="margin: 16px 0;">
        <label style="font-weight: 600; margin-top: 8px;">‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏µ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á MRR)</label>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: flex-end;">
            <div>
                <label style="font-size: 12px;">MRR ‡∏Ç‡∏≠‡∏á‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ (%)</label>
                <input id="promoMrrDisplay" type="text" disabled style="background-color: #e9ecef; font-weight: bold;">
            </div>
            <div>
                <label style="font-size: 12px;">‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏à‡∏≤‡∏Å MRR (%)</label>
                <input id="promoMrrSubtractInput" type="number" step="0.01" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2.20">
            </div>
        </div>
      </div>

      <div class="input-group"><label>‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</label><input id="conditionsInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡∏à‡∏≥"/></div>
      <div class="input-group">
        <label>‡∏≠‡∏≤‡∏¢‡∏∏‡∏ú‡∏π‡πâ‡∏Å‡∏π‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î (‡∏õ‡∏µ)</label>
        <input id="maxLoanAgeInput" type="number" placeholder="‡πÄ‡∏ä‡πà‡∏ô 65 ‡∏´‡∏£‡∏∑‡∏≠ 70 (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ ‡∏à‡∏∞‡πÉ‡∏ä‡πâ 65)">
      </div>
      <div class="input-group"><label>‡∏™‡∏µ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ï‡πå (Hex)</label><input id="colorInput" value="#667eea"/></div>
      <input type="hidden" id="promoIdInput"/>
      <div class="export-section">
        <button class="btn-secondary" onclick="savePromotion()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏õ‡∏£</button>
        <button class="btn-secondary btn-danger" onclick="clearPromoForm()">üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
      </div>
      <div style="margin-top:14px">
        <h3 style="text-align:center;margin-bottom:8px">‡πÇ‡∏õ‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö ‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin)</h3>
        <div id="myPromoList"></div>
      </div>
    </div>

    <div class="card full">
      <h2>üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ (12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏£‡∏Å)</h2>
      <table class="amortization">
        <thead><tr><th width="10%">‡∏á‡∏ß‡∏î</th><th width="22%">‡∏¢‡∏≠‡∏î‡∏ú‡πà‡∏≠‡∏ô</th><th width="22%">‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô</th><th width="22%">‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢</th><th width="24%">‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th></tr></thead>
        <tbody id="amortizationTable"></tbody>
      </table>
    </div>
  </div>
  <div id="toastContainer"></div>
  <div id="globalSpinner" class="spinner-overlay" role="status" aria-live="polite" aria-label="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô">
    <div class="spinner"></div>
    <div class="spinner-label">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...</div>
  </div>

  <script>
// ===== Config =====
    const SUPABASE_URL = 'https://crgyqlfotaceyvoxatnq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI√±iIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNyZ3lxbGZvdGFjZXl2b3hhdG5xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5ODg5NzAsImV4cCI6MjA3MjU2NDk3MH0.pvSRkwkkCQNyRuG-cFadLTQjL6Cf73d4Nu7ur3YSn2U';
    const USE_SUPABASE = true;

    var supabaseClient = null;
    var promoByBank = {};
    var allBanks = []; // NEW: To store bank data {id, bank_name, current_mrr}

    let currentUser = null;
    let isAdmin = false;

    // ===== Utils =====
    const fmt = n => new Intl.NumberFormat('th-TH').format(Math.round(n||0));
    let doughnut = null;

    function addFixedRateYear(year = '', rate = '') {
      const container = document.getElementById('fixedRatesContainer');
      const rateDiv = document.createElement('div');
      rateDiv.className = 'fixed-rate-row';
      rateDiv.style.display = 'grid';
      rateDiv.style.gridTemplateColumns = '1fr 1fr auto';
      rateDiv.style.gap = '10px';
      rateDiv.style.marginBottom = '8px';
      rateDiv.innerHTML = `<input type="number" class="fixed-rate-year-input" placeholder="‡∏õ‡∏µ‡∏ó‡∏µ‡πà" value="${year}"><input type="number" step="0.01" class="fixed-rate-rate-input" placeholder="‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ %" value="${rate}"><button type="button" class="btn-danger" onclick="this.parentElement.remove()" style="padding: 6px 10px;">‡∏•‡∏ö</button>`;
      container.appendChild(rateDiv);
    }
    
    // UI Helpers
    function setLibUIReady(ready){ /* ... unchanged ... */ }
    function initSupabase(){ /* ... unchanged ... */ }
    function waitForSupabase(timeout=8000){ /* ... unchanged ... */ }
    function showSpinner(text='...'){ /* ... unchanged ... */ }
    function hideSpinner(){ /* ... unchanged ... */ }
    function toast(message,type='info'){ /* ... unchanged ... */ }
    
    // Auth Functions
    async function login(){ /* ... unchanged ... */ }
    function showLoginError(msg){ /* ... unchanged ... */ }
    async function determineAdmin(){ /* ... unchanged ... */ }
    async function logout(){ /* ... unchanged ... */ }

    function updateAuthUI(loggedIn) {
      const loginArea = document.getElementById('loginArea');
      const userArea  = document.getElementById('userArea');
      const who = document.getElementById('who');
      const badge = document.getElementById('roleBadge');
      const adminPane = document.getElementById('promoAdmin');
      const bankPane = document.getElementById('bankAdmin'); // NEW
      
      if(loggedIn && currentUser){
        loginArea.style.display='none'; userArea.style.display='flex';
        who.textContent = currentUser.email; badge.textContent = isAdmin ? '‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: ADMIN' : '‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: USER';
        if (isAdmin) {
          adminPane.style.display = 'block';
          bankPane.style.display = 'block'; // NEW
        } else {
          adminPane.style.display = 'none';
          bankPane.style.display = 'none'; // NEW
        }
      } else {
        loginArea.style.display='block'; userArea.style.display='none';
        adminPane.style.display = 'none';
        bankPane.style.display = 'none'; // NEW
      }
      const pwd=document.getElementById('password'); if(pwd) pwd.value='';
    }

    // ===== NEW: Bank Management Functions =====
    async function fetchBanks() {
      if (!supabaseClient) return;
      try {
        const { data, error } = await supabaseClient.from('banks').select('id, bank_name, current_mrr').order('bank_name');
        if (error) throw error;
        allBanks = data || [];
        renderBankList();
        populateBankDropdown();
      } catch (e) {
        console.error("Failed to fetch banks:", e);
        toast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÑ‡∏î‡πâ', 'error');
      }
    }

    function renderBankList() {
      const container = document.getElementById('bankMasterList');
      if (!container) return;
      if (allBanks.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:#666">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</p>';
        return;
      }
      container.innerHTML = allBanks.map(bank => `
        <div style="padding:10px;border-bottom:1px solid #e9ecef;display:flex;justify-content:space-between;align-items:center;">
          <div><strong>${bank.bank_name}</strong> <span style="color:#555;">(MRR: ${bank.current_mrr}%)</span></div>
          <div style="display:flex;gap:6px">
            <button class="btn-secondary" style="padding:6px 10px;font-size:12px" onclick='editBank(${JSON.stringify(bank)})'>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button class="btn-danger" style="padding:6px 10px;font-size:12px" onclick="deleteBank('${bank.id}', '${bank.bank_name}')">‡∏•‡∏ö</button>
          </div>
        </div>
      `).join('');
    }
    
    function populateBankDropdown() {
      const select = document.getElementById('bankNameSelect');
      if (!select) return;
      // Keep the first option
      select.innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ --</option>';
      allBanks.forEach(bank => {
        const option = document.createElement('option');
        option.value = bank.bank_name;
        option.textContent = bank.bank_name;
        select.appendChild(option);
      });
    }

    function clearBankForm() {
      document.getElementById('bankIdInput').value = '';
      document.getElementById('bankNameMasterInput').value = '';
      document.getElementById('bankMrrMasterInput').value = '';
    }

    function editBank(bank) {
      document.getElementById('bankIdInput').value = bank.id;
      document.getElementById('bankNameMasterInput').value = bank.bank_name;
      document.getElementById('bankMrrMasterInput').value = bank.current_mrr;
      window.scrollTo({ top: document.getElementById('bankAdmin').offsetTop - 20, behavior: 'smooth' });
    }

    async function saveBank() {
      if (!isAdmin) return;
      const id = document.getElementById('bankIdInput').value;
      const bank_name = document.getElementById('bankNameMasterInput').value.trim();
      const current_mrr = parseFloat(document.getElementById('bankMrrMasterInput').value);

      if (!bank_name || isNaN(current_mrr)) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤ MRR ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        return;
      }
      
      const bankData = { bank_name, current_mrr };

      try {
        if (id) {
          const { error } = await supabaseClient.from('banks').update(bankData).eq('id', id);
          if (error) throw error;
        } else {
          const { error } = await supabaseClient.from('banks').insert(bankData);
          if (error) throw error;
        }
        toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        clearBankForm();
        await fetchBanks(); // Refresh list
      } catch (e) {
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message);
      }
    }
    
    async function deleteBank(id, name) {
        if (!isAdmin || !confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏•‡∏ö‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ "${name}"?\n(‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ)`)) return;
        try {
            const { error } = await supabaseClient.from('banks').delete().eq('id', id);
            if (error) throw error;
            toast('‡∏•‡∏ö‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            await fetchBanks();
        } catch (e) {
            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message);
        }
    }
    
    // ===== MODIFIED: Promotion Form Functions =====
    
    function handleBankSelectionChange() {
        const selectedBankName = document.getElementById('bankNameSelect').value;
        const mrrDisplay = document.getElementById('promoMrrDisplay');
        if (selectedBankName) {
            const bank = allBanks.find(b => b.bank_name === selectedBankName);
            mrrDisplay.value = bank ? bank.current_mrr.toFixed(2) : '';
        } else {
            mrrDisplay.value = '';
        }
    }

    function parseRatesFromForm() {
      const rates = [];
      document.querySelectorAll('.fixed-rate-row').forEach(row => {
        const year = parseInt(row.querySelector('.fixed-rate-year-input').value, 10);
        const rate = parseFloat(row.querySelector('.fixed-rate-rate-input').value);
        if (!isNaN(year) && !isNaN(rate)) {
          rates.push({ year, rate, description: `‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡∏õ‡∏µ‡∏ó‡∏µ‡πà ${year}` });
        }
      });
      
      const bankMrr = parseFloat(document.getElementById('promoMrrDisplay').value);
      const subtractVal = parseFloat(document.getElementById('promoMrrSubtractInput').value);

      if (!isNaN(bankMrr) && !isNaN(subtractVal)) {
        const effectiveRate = bankMrr - subtractVal;
        const description = `MRR (${bankMrr.toFixed(2)}%) - ${subtractVal.toFixed(2)}%`;
        rates.push({ year: 99, rate: effectiveRate, description: description });
      }

      return rates.sort((a, b) => a.year - b.year);
    }
    
    function populateFormWithRates(rates = []) {
      clearPromoFormFields();
      (rates || []).forEach(rate => {
        if (rate.year === 99) {
          const desc = rate.description || '';
          const match = desc.match(/MRR\s*\((\d+\.?\d*)\%\)\s*-\s*(\d+\.?\d*)\%/);
          if (match && match.length === 3) {
            document.getElementById('promoMrrDisplay').value = match[1];
            document.getElementById('promoMrrSubtractInput').value = match[2];
          }
        } else {
          addFixedRateYear(rate.year, rate.rate);
        }
      });
    }
    
    function clearPromoFormFields() {
        document.getElementById('fixedRatesContainer').innerHTML = '';
        document.getElementById('promoMrrDisplay').value = '';
        document.getElementById('promoMrrSubtractInput').value = '';
    }
    
    function clearPromoForm() {
      document.getElementById('promoIdInput').value = '';
      document.getElementById('bankNameSelect').value = '';
      document.getElementById('promoNameInput').value = '';
      document.getElementById('conditionsInput').value = '';
      document.getElementById('maxLoanAgeInput').value = '';
      document.getElementById('colorInput').value = '#667eea';
      clearPromoFormFields();
    }
    
    async function savePromotion() {
      if (!isAdmin) return;
      
      const id = document.getElementById('promoIdInput').value.trim();
      const bank_name = document.getElementById('bankNameSelect').value;
      const name = document.getElementById('promoNameInput').value.trim();
      const rates = parseRatesFromForm();
      const conditions = document.getElementById('conditionsInput').value.trim();
      const max_loan_age = parseInt(document.getElementById('maxLoanAgeInput').value, 10) || 65;
      const color = document.getElementById('colorInput').value.trim();

      if (!bank_name || !name || rates.length === 0) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£, ‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£, ‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
        return;
      }
      
      const promoData = { bank_name, name, rates, conditions, max_loan_age, color };

      try {
        if (id) {
          const { error } = await supabaseClient.from('bank_promotions').update(promoData).eq('id', id);
          if (error) throw error;
        } else {
          const { error } = await supabaseClient.from('bank_promotions').insert([promoData]);
          if (error) throw error;
        }
        toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        clearPromoForm();
        await fetchPromotions();
      } catch (e) {
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message);
      }
    }
    
    function editPromotion(p) {
        if (!isAdmin) return;
        document.getElementById('promoIdInput').value = p.id || '';
        document.getElementById('bankNameSelect').value = p.bank_name || ''; // Use bank_name
        handleBankSelectionChange(); // Trigger MRR display
        document.getElementById('promoNameInput').value = p.name || '';
        populateFormWithRates(p.rates || []);
        document.getElementById('conditionsInput').value = p.conditions || '';
        document.getElementById('maxLoanAgeInput').value = p.max_loan_age || '';
        document.getElementById('colorInput').value = p.color || '#667eea';
        window.scrollTo({ top: document.getElementById('promoAdmin').offsetTop - 20, behavior: 'smooth' });
    }
    
    // Main calculation functions (calculateLoan, compareBanks, etc.) are mostly unchanged
    // But we need to refetch both banks and promos on start
    async function start(){
      showSpinner('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
      const ok = await waitForSupabase();
      if(!ok){ setLibUIReady(false); return; }
      initSupabase();
      if(supabaseClient){ setLibUIReady(true); }
      await restoreSession();
      await fetchBanks(); // Fetch banks first
      await fetchPromotions(); // Then fetch promos
      calculateLoan();
      hideSpinner();
      
      document.getElementById('rateUpdateTime').textContent=`‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${new Date().toLocaleString('th-TH')}`;
      ['housePrice', 'borrowerAge', 'borrowerSalary', 'borrowerBonus', 'borrowerOtherIncome', 'borrowerDebt'].forEach(id => {
          const element = document.getElementById(id);
          if (element) {
              element.addEventListener('input', calculateLoan);
          }
      });
    }

    // Unchanged functions below this line
    function calcMonthly(principal, annual, years){ /* ... */ }
    function getBestPromoRate(){ /* ... */ }
    function calculateMaxLoan(monthlyPayment, annualRate, years){ /* ... */ }
    function calcTiered(principal, tiers, years){ /* ... */ }
    function calculateLoan(){ /* ... */ }
    function compareBanks(loanAmount, borrowerAge){ /* ... */ }
    function buildChart(p,i){ /* ... */ }
    function buildAmort(loan, rate, years, pay){ /* ... */ }
    async function fetchPromotions(){ /* Minor changes needed */ }
    function getCurrentLoanAmount() { /* ... */ }
    function showStatus(msg,isErr=false){ /* ... */ }
    function renderPromoList(){ /* Major changes needed */ }
    async function deletePromotion(id){ /* ... */ }
    function saveLoanLocal() { /* ... */ }
    async function refreshPromos(){ 
        showSpinner('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä...'); 
        await fetchBanks(); 
        await fetchPromotions(); 
        hideSpinner(); 
    }
    async function restoreSession(){ /* ... */ }
    document.addEventListener('DOMContentLoaded', start);
  </script>

</body>
</html>