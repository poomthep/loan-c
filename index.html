<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡πâ‡∏≤‡∏ô ‚Äî Login-only (No Signup) + Admin Gate</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/supabase-js/2.38.0/umd/supabase.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
    .container{max-width:1200px;margin:0 auto}
    .header{color:#fff;text-align:center;margin-bottom:18px}
    .header h1{font-size:2.2rem;margin-bottom:6px;text-shadow:2px 2px 4px rgba(0,0,0,.25)}
    .card{background:rgba(255,255,255,.96);border-radius:20px;padding:22px;box-shadow:0 15px 35px rgba(0,0,0,.1);border:1px solid rgba(255,255,255,.2)}
    .blur{background:rgba(255,255,255,.12);backdrop-filter: blur(8px); border:1px solid rgba(255,255,255,.25);color:#fff}
    .main-grid{display:grid;grid-template-columns:1fr 1fr;gap:22px}
    .full{grid-column:1/-1}
    .input-group{margin-bottom:14px}
    .input-group label{display:block;margin-bottom:6px;color:#444;font-weight:600}
    .input-group input,.input-group select{width:100%;padding:12px;border:2px solid #e1e5e9;border-radius:10px;font-size:16px}
    .btn{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;padding:12px 18px;border-radius:10px;font-weight:700;cursor:pointer}
    .btn.block{width:100%}
    .btn-secondary{background:linear-gradient(135deg,#20bf6b 0%,#01a3a4 100%);color:#fff;border:none;padding:10px 16px;border-radius:8px;font-weight:700;cursor:pointer}
    .btn-danger{background:linear-gradient(135deg,#ff6b6b 0%,#ee5a52 100%)}
    .export-section{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .results-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:10px}
    .result-item{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);color:#fff;border-radius:15px;padding:18px;text-align:center}
    .result-item .value{font-size:1.4rem;font-weight:800}
    .chart-container{position:relative;height:300px;margin-top:14px}
    .bank-comparison{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;margin-top:12px}
    .bank-card{background:#fff;border-radius:14px;padding:16px;border-left:5px solid #667eea;box-shadow:0 10px 24px rgba(0,0,0,.08)}
    .bank-name{font-weight:800;color:#333}
    .selected-promotion{display:inline-block;margin-top:4px;background:#f3f4f6;padding:2px 8px;border-radius:999px;font-size:12px;color:#666}
    .rate-year{display:flex;justify-content:space-between;font-size:14px}
    .amortization{width:100%;border-collapse:collapse;margin-top:10px}
    .amortization th,.amortization td{padding:10px;border-bottom:1px solid #e9ecef;text-align:right}
    .amortization thead{background:#667eea;color:#fff}
    .notice{background:#fff3cd;color:#8a6d3b;border:1px solid #ffeaa7;padding:12px;border-radius:10px;margin-top:8px}
    .login-grid{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:end}
    .welcome{display:flex;justify-content:space-between;align-items:center;gap:10px}
    @media (max-width:900px){.main-grid{grid-template-columns:1fr}.login-grid{grid-template-columns:1fr}.welcome{flex-direction:column;align-items:flex-start}}
  </style>
</head>
<body>
  <div class="container">
    <!-- Login bar: Login-only (No signup) -->
    <div class="card blur" style="margin-bottom:14px">
      <div id="loginArea">
        <div class="login-grid">
          <div class="input-group" style="margin:0">
            <label style="color:#fff">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
            <input id="email" type="email" placeholder="admin@yourbank.com" />
          </div>
          <div class="input-group" style="margin:0">
            <label style="color:#fff">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
            <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          </div>
          <button class="btn" onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
        <div id="loginError" style="display:none;margin-top:8px;background:#ff6b6b99;padding:8px 10px;border-radius:8px">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</div>
        <div style="margin-top:6px;font-size:12px;opacity:.9">* ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ‚Äî ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ñ‡∏π‡∏Å‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ô Supabase ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div>
      </div>
      <div id="userArea" class="welcome" style="display:none">
        <div>
          <div style="font-weight:700">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö <span id="who"></span></div>
          <div id="roleBadge" style="font-size:12px;opacity:.9"></div>
        </div>
        <div style="display:flex;gap:10px">
          <button class="btn-secondary" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
          <button class="btn-secondary" onclick="refreshPromos()">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÇ‡∏õ‡∏£</button>
        </div>
      </div>
    </div>

    <div class="header">
      <h1>üè† ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡πâ‡∏≤‡∏ô</h1>
      <div>Login-only + Admin Gate ‚Äî ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡πÄ‡∏´‡πá‡∏ô/‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡πÅ‡∏Å‡πâ‡πÇ‡∏õ‡∏£‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin</div>
    </div>

    <div class="main-grid">
      <div class="card">
        <h2>üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠</h2>
        <div class="input-group"><label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô (‡∏ö‡∏≤‡∏ó)</label><input id="housePrice" type="number" value="5000000"></div>
        <div class="input-group"><label>‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå (%)</label><input id="downPayment" type="number" value="20" min="0" max="100"></div>
        <div class="input-group"><label>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (% ‡∏ï‡πà‡∏≠‡∏õ‡∏µ)</label><input id="interestRate" type="number" value="3.5" step="0.05"></div>
        <div class="input-group"><label>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏π‡πâ (‡∏õ‡∏µ)</label>
          <select id="loanTerm">
            <option value="10">10 ‡∏õ‡∏µ</option><option value="15">15 ‡∏õ‡∏µ</option><option value="20">20 ‡∏õ‡∏µ</option><option value="25">25 ‡∏õ‡∏µ</option><option value="30" selected>30 ‡∏õ‡∏µ</option><option value="35">35 ‡∏õ‡∏µ</option>
          </select>
        </div>
        <div class="input-group"><label>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ö‡∏≤‡∏ó)</label><input id="monthlyIncome" type="number" value="80000"></div>
        <button class="btn block" onclick="calculateLoan()">üîç ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠</button>
        <div class="export-section">
          <button class="btn-secondary" onclick="saveLoanLocal()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ)</button>
          <button class="btn-secondary" onclick="exportToPDF()">üìÑ Export PDF</button>
          <button class="btn-secondary" onclick="refreshPromos()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÇ‡∏õ‡∏£‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô</button>
        </div>
        <div id="debtNotice" class="notice" style="display:none"></div>
      </div>

      <div class="card">
        <h2>üí∞ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢)</h2>
        <div class="results-grid">
          <div class="result-item"><div>‡∏¢‡∏≠‡∏î‡∏Å‡∏π‡πâ‡∏¢‡∏∑‡∏°</div><div id="loanAmount" class="value">-</div></div>
          <div class="result-item"><div>‡∏ú‡πà‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div><div id="monthlyPayment" class="value">-</div></div>
          <div class="result-item"><div>‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏£‡∏ß‡∏°</div><div id="totalInterest" class="value">-</div></div>
          <div class="result-item"><div>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°</div><div id="totalCost" class="value">-</div></div>
        </div>
        <div class="chart-container"><canvas id="paymentChart"></canvas></div>
      </div>
    </div>

    <div class="card full">
      <h2>üè¶ ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</h2>
      <div id="promoStatus" class="notice" style="display:none"></div>
      <div id="bankComparison" class="bank-comparison"></div>
      <div id="rateUpdateTime" style="text-align:center;color:#666;margin-top:6px"></div>
    </div>

    <!-- Admin Panel: hidden unless isAdmin === true -->
    <div class="card full" id="promoAdmin" style="display:none">
      <h2>üõ†Ô∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡πÇ‡∏õ‡∏£‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ (Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)</h2>
      <div class="input-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</label><input id="bankNameInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢"/></div>
      <div class="input-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô</label><input id="promoNameInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©"/></div>
      <div class="input-group"><label>‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏á: ‡∏õ‡∏µ,‡∏≠‡∏±‡∏ï‡∏£‡∏≤%,‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢)</label>
        <textarea id="ratesInput" rows="4" style="width:100%;padding:12px;border:2px solid #e1e5e9;border-radius:10px" placeholder="1,1.99,MRR-5.31%&#10;2,2.99,MRR-4.31%&#10;3,3.99,MRR-3.31%"></textarea>
      </div>
      <div class="input-group"><label>‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</label><input id="conditionsInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡∏à‡∏≥"/></div>
      <div class="input-group"><label>‡∏™‡∏µ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ï‡πå (Hex)</label><input id="colorInput" value="#667eea"/></div>
      <input type="hidden" id="promoIdInput"/>
      <div class="export-section">
        <button class="btn-secondary" onclick="savePromotion()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏õ‡∏£</button>
        <button class="btn-secondary btn-danger" onclick="clearPromoForm()">üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
      </div>
      <div style="margin-top:14px">
        <h3 style="text-align:center;margin-bottom:8px">‡πÇ‡∏õ‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö ‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin)</h3>
        <div id="myPromoList"></div>
      </div>
    </div>

    <div class="card full">
      <h2>üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ (12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏£‡∏Å)</h2>
      <table class="amortization">
        <thead><tr><th width="10%">‡∏á‡∏ß‡∏î</th><th width="22%">‡∏¢‡∏≠‡∏î‡∏ú‡πà‡∏≠‡∏ô</th><th width="22%">‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô</th><th width="22%">‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢</th><th width="24%">‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th></tr></thead>
        <tbody id="amortizationTable"></tbody>
      </table>
    </div>
  </div>

  <script>
    // ===== Config =====
    const SUPABASE_URL = 'https://crgyqlfotaceyvoxatnq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNyZ3lxbGZvdGFjZXl2b3hhdG5xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5ODg5NzAsImV4cCI6MjA3MjU2NDk3MH0.pvSRkwkkCQNyRuG-cFadLTQjL6Cf73d4Nu7ur3YSn2U';
    const USE_SUPABASE = true; // ‡πÉ‡∏ä‡πâ‡∏ê‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏™‡∏°‡∏≠
    let supabaseClient = null;

    // Auth state
    let currentUser = null;
    let isAdmin = false; // gate UI + CRUD

    // ===== Utils =====
    const fmt = n => new Intl.NumberFormat('th-TH').format(Math.round(n||0));
    let doughnut = null;

    // ===== Init Supabase =====
    function initSupabase(){
      if (USE_SUPABASE && !supabaseClient && window.supabase) {
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      }
    }

    // ===== Auth (Login-only) =====
    async function login(){
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const err = document.getElementById('loginError');
      err.style.display = 'none';
      if(!email || !password){ err.textContent='‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô'; err.style.display='block'; return; }
      try{
        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if(error) throw error;
        currentUser = data.user;
        await determineAdmin();
        updateAuthUI(true);
        await fetchPromotions();
      }catch(e){ err.textContent = (e.message==='Invalid login credentials') ? '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á' : ('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: '+e.message); err.style.display='block'; }
    }

    async function determineAdmin(){
      // ‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á user_roles (‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏ô DB)
      try{
        const { data, error } = await supabaseClient.from('user_roles').select('role').eq('user_id', currentUser.id).maybeSingle();
        if(error) throw error;
        isAdmin = (data && (data.role||'').toLowerCase()==='admin');
      }catch(e){ console.warn('‡∏ï‡∏£‡∏ß‡∏à‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:', e); isAdmin = false; }
    }

    async function logout(){
      try{ await supabaseClient.auth.signOut(); } catch(e){}
      currentUser=null; isAdmin=false; updateAuthUI(false);
    }

    function updateAuthUI(loggedIn){
      const loginArea = document.getElementById('loginArea');
      const userArea  = document.getElementById('userArea');
      const who = document.getElementById('who');
      const badge = document.getElementById('roleBadge');
      const adminPane = document.getElementById('promoAdmin');
      if(loggedIn && currentUser){
        loginArea.style.display='none'; userArea.style.display='flex';
        who.textContent = currentUser.email;
        badge.textContent = isAdmin ? '‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: ADMIN' : '‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: USER';
        adminPane.style.display = isAdmin ? 'block' : 'none';
      } else {
        loginArea.style.display='block'; userArea.style.display='none';
        adminPane.style.display='none';
      }
      // clear password
      const pwd=document.getElementById('password'); if(pwd) pwd.value='';
    }

    // ===== Calculations =====
    function calcMonthly(principal, annual, years){
      const r = (annual/100)/12; const n = years*12; if(r===0) return principal/n; return principal*r*Math.pow(1+r,n)/(Math.pow(1+r,n)-1);
    }
    function calcTiered(principal, tiers, years){
      const n = years*12; let bal = principal; let totI = 0; const avg = tiers.reduce((a,t)=>a+t.rate,0)/tiers.length; const pay = calcMonthly(principal, avg, years);
      for(let m=1;m<=n;m++){ const yr=Math.ceil(m/12); let ra=tiers[tiers.length-1].rate; for(const t of tiers){ if(yr<=t.year){ ra=t.rate; break; } } const mr=ra/100/12; const i=bal*mr; totI+=i; const p=pay-i; bal-=p; if(bal<=0) break; }
      return { monthly: pay, interest: totI };
    }

    function calculateLoan(){
      const house=+document.getElementById('housePrice').value||0;
      const dp=+document.getElementById('downPayment').value||0;
      const rate=+document.getElementById('interestRate').value||0;
      const years=+document.getElementById('loanTerm').value||30;
      const income=+document.getElementById('monthlyIncome').value||0;
      const loan=house - (house*dp/100);
      const pay=calcMonthly(loan, rate, years);
      const tot = pay*years*12; const ti = tot - loan;
      document.getElementById('loanAmount').textContent = fmt(loan)+' ‡∏ö‡∏≤‡∏ó';
      document.getElementById('monthlyPayment').textContent = fmt(pay)+' ‡∏ö‡∏≤‡∏ó';
      document.getElementById('totalInterest').textContent = fmt(ti)+' ‡∏ö‡∏≤‡∏ó';
      document.getElementById('totalCost').textContent = fmt(house+ti)+' ‡∏ö‡∏≤‡∏ó';
      const note = document.getElementById('debtNotice');
      if(income>0){ const d=(pay/income)*100; note.style.display='block'; note.textContent = d<=30?`‚úÖ DSR ~ ${d.toFixed(1)}% (‡∏î‡∏µ)` : d<=40?`‚ö†Ô∏è DSR ~ ${d.toFixed(1)}% (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏∂‡∏á)` : `üö® DSR ~ ${d.toFixed(1)}% (‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á)`; } else { note.style.display='none'; }
      buildChart(loan, ti); buildAmort(loan, rate, years, pay); compareBanks(loan, years);
    }

    function buildChart(p,i){ const ctx=document.getElementById('paymentChart'); if(!ctx) return; if(doughnut) doughnut.destroy(); doughnut=new Chart(ctx,{type:'doughnut',data:{labels:['‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô','‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢'],datasets:[{data:[p,i],backgroundColor:['#667eea','#f093fb'],borderWidth:3,borderColor:'#fff'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom'}}}}); }

    function buildAmort(loan, rate, years, pay){ const tb=document.getElementById('amortizationTable'); tb.innerHTML=''; const mr=rate/100/12; let bal=loan; for(let m=1;m<=12;m++){ const i=bal*mr; const pr=pay-i; bal-=pr; const tr=document.createElement('tr'); tr.innerHTML=`<td style="text-align:center">${m}</td><td>${fmt(pay)}</td><td>${fmt(pr)}</td><td>${fmt(i)}</td><td>${fmt(Math.max(0,bal))}</td>`; tb.appendChild(tr);} }

    // ===== Promotions (Supabase) =====
const parseRates = txt => (txt||'').split('\n').map(l=>{const[a,b,c]=l.split(',');const y=parseInt((a||'').trim(),10);const r=parseFloat((b||'').trim());const d=(c||'').trim();return (!isNaN(y)&&!isNaN(r))?{year:y,rate:r,description:d}:null}).filter(Boolean).sort((x,y)=>x.year-y.year);
const ratesToText = rs => (rs||[]).map(r=>`${r.year},${r.rate}${r.description?','+r.description:''}`).join('\n');

    async function fetchPromotions(){
      if(!supabaseClient) return;
      try{
        const { data, error } = await supabaseClient.from('bank_promotions').select('id,bank_name,name,rates,conditions,color').order('bank_name',{ascending:true}).order('created_at',{ascending:false});
        if(error) throw error;
        const g={}; (data||[]).forEach(row=>{ (g[row.bank_name]=g[row.bank_name]||[]).push({id:row.id,name:row.name,rates:row.rates||[],conditions:row.conditions||'',color:row.color||'#667eea'}); });
        promoByBank=g; renderPromoList(); compareBanks(getCurrentLoanAmount(), +document.getElementById('loanTerm').value||30);
        document.getElementById('rateUpdateTime').textContent = `‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${new Date().toLocaleString('th-TH')}`;
      }catch(e){ console.error(e); showStatus('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡πÇ‡∏õ‡∏£‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', true); }
    }

    function getCurrentLoanAmount(){ const house=+document.getElementById('housePrice').value||0; const dp=+document.getElementById('downPayment').value||0; return house - (house*dp/100); }

    function showStatus(msg,isErr=false){ const el=document.getElementById('promoStatus'); el.style.display='block'; el.textContent = (isErr?'‚ùå ':'‚úÖ ')+msg; setTimeout(()=>{el.style.display='none'},3000); }

    async function savePromotion(){
      if(!isAdmin){ alert('‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Admin) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô'); return; }
      const id=(document.getElementById('promoIdInput').value||'').trim();
      const bank=(document.getElementById('bankNameInput').value||'').trim();
      const name=(document.getElementById('promoNameInput').value||'').trim();
      const rates=parseRates(document.getElementById('ratesInput').value);
      const conditions=(document.getElementById('conditionsInput').value||'').trim();
      const color=(document.getElementById('colorInput').value||'#667eea').trim();
      if(!bank||!name||rates.length===0){ alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£/‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£ + ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î'); return; }
      try{
        if(id){ const { error } = await supabaseClient.from('bank_promotions').update({ bank_name:bank,name,rates,conditions,color }).eq('id',id); if(error) throw error; showStatus('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏õ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); }
        else { const { error } = await supabaseClient.from('bank_promotions').insert([{ bank_name:bank,name,rates,conditions,color,is_public:true }]); if(error) throw error; showStatus('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏õ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); }
        clearPromoForm(); await fetchPromotions();
      }catch(e){ alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: '+e.message); }
    }

    function clearPromoForm(){ document.getElementById('promoIdInput').value=''; document.getElementById('bankNameInput').value=''; document.getElementById('promoNameInput').value=''; document.getElementById('ratesInput').value=''; document.getElementById('conditionsInput').value=''; document.getElementById('colorInput').value='#667eea'; }

    function renderPromoList(){
      const h=document.getElementById('myPromoList'); if(!h) return;
      const flat=[]; Object.keys(promoByBank).forEach(b=>{ (promoByBank[b]||[]).forEach(p=>flat.push({bank:b,...p})) });
      if(flat.length===0){ h.innerHTML='<p style="text-align:center;color:#666">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>'; return; }
      h.innerHTML = flat.map(p=>`
        <div style="padding:10px;border:1px solid #e9ecef;border-radius:10px;margin:6px 0;">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>${p.bank}</strong> ‚Äî ${p.name}</div>
            ${isAdmin ? `<div style="display:flex;gap:6px">
              <button class="btn-secondary" style="padding:6px 10px;font-size:12px" onclick='editPromotion(${JSON.stringify(p)})'>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              <button class="btn-danger" style="padding:6px 10px;font-size:12px" onclick="deletePromotion('${p.id}')">‡∏•‡∏ö</button>
            </div>` : ''}
          </div>
          <div style="font-size:12px;color:#555;margin-top:4px">${p.conditions||''}</div>
          <div style="font-size:12px;margin-top:6px">${(p.rates||[]).map(r=>`‡∏õ‡∏µ‡∏ó‡∏µ‡πà ${r.year}: ${r.rate}% <span style=\"color:#6c757d\">${r.description||''}</span>`).join('<br>')}</div>
        </div>`).join('');
      // ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏û‡∏≤‡πÄ‡∏ô‡∏•
      document.getElementById('promoAdmin').style.display = isAdmin ? 'block':'none';
    }

    function editPromotion(p){ if(!isAdmin) return; document.getElementById('promoIdInput').value=p.id||''; document.getElementById('bankNameInput').value=p.bank||''; document.getElementById('promoNameInput').value=p.name||''; document.getElementById('ratesInput').value=ratesToText(p.rates||[]); document.getElementById('conditionsInput').value=p.conditions||''; document.getElementById('colorInput').value=p.color||'#667eea'; window.scrollTo({top:document.getElementById('promoAdmin').offsetTop-10,behavior:'smooth'}); }

    async function deletePromotion(id){ if(!isAdmin||!id||!confirm('‡∏•‡∏ö‡πÇ‡∏õ‡∏£‡∏ô‡∏µ‡πâ?')) return; try{ const { error } = await supabaseClient.from('bank_promotions').delete().eq('id',id); if(error) throw error; await fetchPromotions(); showStatus('‡∏•‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); }catch(e){ alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: '+e.message); } }

    // ===== Comparison UI =====
    function compareBanks(loanAmount, years){ const box=document.getElementById('bankComparison'); if(!box) return; box.innerHTML=''; const data=promoByBank; Object.keys(data).forEach(bank=>{ const promos=data[bank]; promos.forEach(promo=>{ const c=calcTiered(loanAmount,promo.rates,years); const card=document.createElement('div'); card.className='bank-card'; card.style.borderLeftColor=promo.color||'#667eea'; card.innerHTML=`<div class="bank-name">${bank}</div><div class="selected-promotion">${promo.name}</div><div style="margin-top:8px">${promo.rates.map(r=>`<div class='rate-year'><span>‡∏õ‡∏µ‡∏ó‡∏µ‡πà ${r.year}${r.year===promo.rates[promo.rates.length-1].year&&promo.rates.length>1?' ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏õ':''}</span><span>${r.rate}%</span></div><div style='text-align:right;color:#6c757d;font-size:11px'>${r.description||''}</div>`).join('')}</div><div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:8px"><div><strong>‡∏ú‡πà‡∏≠‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</strong><br>${fmt(c.monthly)} ‡∏ö‡∏≤‡∏ó</div><div><strong>‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏£‡∏ß‡∏°</strong><br>${fmt(c.interest)} ‡∏ö‡∏≤‡∏ó</div></div>`; box.appendChild(card); }); }); }

    // ===== Local save (no server save) =====
    function saveLoanLocal(){ const item={ ts:Date.now(), house:+housePrice.value||0, down:+downPayment.value||0, rate:+interestRate.value||0, term:+loanTerm.value||30, income:+monthlyIncome.value||0, results:{ loan:loanAmount.textContent, pay:monthlyPayment.textContent, interest:totalInterest.textContent, total:totalCost.textContent } }; const arr=JSON.parse(localStorage.getItem('loan_saves')||'[]'); arr.unshift(item); localStorage.setItem('loan_saves', JSON.stringify(arr)); showStatus('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß'); }

    async function refreshPromos(){ await fetchPromotions(); }

    // ===== Boot =====
    async function restoreSession(){
      const { data } = await supabaseClient.auth.getUser();
      if(data && data.user){ currentUser=data.user; await determineAdmin(); updateAuthUI(true); }
    }

    function start(){
      initSupabase();
      restoreSession();
      calculateLoan();
      fetchPromotions();
      document.getElementById('rateUpdateTime').textContent=`‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${new Date().toLocaleString('th-TH')}`;
      ['housePrice','downPayment','interestRate','loanTerm','monthlyIncome'].forEach(id=>document.getElementById(id).addEventListener('input',calculateLoan));
      document.getElementById('password').addEventListener('keypress',e=>{ if(e.key==='Enter') login(); });
    }
    document.addEventListener('DOMContentLoaded', start);
  </script>
</body>
</html>
