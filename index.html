<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡πâ‡∏≤‡∏ô</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box}

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px}

        .container {
            max-width: 1200px;
            margin: 0 auto}

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px}

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3)}

        .header p {
            font-size: 1.2em;
            opacity: 0.9}

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px}

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2)}

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            text-align: center;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px}

        .input-group {
            margin-bottom: 20px}

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600}

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease}

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1)}

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            width: 100%;
            margin-top: 10px}

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3)}

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0}

        .result-item {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            color: white;
            box-shadow: 0 10px 20px rgba(240, 147, 251, 0.3)}

        .result-item h3 {
            font-size: 0.9em;
            margin-bottom: 10px;
            opacity: 0.9}

        .result-item .value {
            font-size: 1.5em;
            font-weight: bold}

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px}

        .full-width {
            grid-column: 1 / -1}

        .amortization-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            display: block;
            white-space: nowrap}

        .amortization-table thead {
            background: #667eea;
            color: white;
            position: sticky;
            top: 0}

        .amortization-table th,
        .amortization-table td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #e1e5e9}

        .amortization-table tbody {
            display: block;
            max-height: 300px;
            overflow-y: auto}

        .amortization-table thead,
        .amortization-table tbody tr {
            display: table;
            width: 100%;
            table-layout: fixed}

        .comparison-section {
            margin-top: 30px}

        .bank-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px}

        .bank-card {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 15px;
            border-left: 5px solid #667eea;
            transition: transform 0.2s ease}

        .bank-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.1)}

        .bank-name {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px}

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr}
            
            .header h1 {
                font-size: 2em}
            
            .results-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr))}

        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0}

        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè† ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡πâ‡∏≤‡∏ô</h1>
            <p>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ä‡∏±‡πâ‡∏ô‡∏ô‡∏≥</p>
        </div>

        <div class="main-content">
            <div class="card">
                <h2>üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠</h2>
                <div class="input-group">
                    <label for="housePrice">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                    <input type="number" id="housePrice" placeholder="5,000,000" value="5000000">
                </div>
                
                <div class="input-group">
                    <label for="downPayment">‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå (%)</label>
                    <input type="number" id="downPayment" placeholder="20" value="20" min="0" max="100">
                </div>

                <div class="input-group">
                    <label for="interestRate">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡∏¢ (% ‡∏ï‡πà‡∏≠‡∏õ‡∏µ)</label>
                    <input type="number" id="interestRate" placeholder="3.5" value="3.5" step="0.1">
                </div>

                <div class="input-group">
                    <label for="loanTerm">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏π‡πâ (‡∏õ‡∏µ)</label>
                    <select id="loanTerm">
                        <option value="10">10 ‡∏õ‡∏µ</option>
                        <option value="15">15 ‡∏õ‡∏µ</option>
                        <option value="20">20 ‡∏õ‡∏µ</option>
                        <option value="25">25 ‡∏õ‡∏µ</option>
                        <option value="30" selected>30 ‡∏õ‡∏µ</option>
                        <option value="35">35 ‡∏õ‡∏µ</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="monthlyIncome">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                    <input type="number" id="monthlyIncome" placeholder="80,000" value="80000">
                </div>

                <button class="btn" onclick="calculateLoan()">üîç ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠</button>
            </div>

            <div class="card">
                <h2>üí∞ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h2>
                <div class="results-grid">
                    <div class="result-item">
                        <h3>‡∏¢‡∏≠‡∏î‡∏Å‡∏π‡πâ‡∏¢‡∏∑‡∏°</h3>
                        <div class="value" id="loanAmount">-</div>
                    </div>
                    <div class="result-item">
                        <h3>‡∏ú‡πà‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
                        <div class="value" id="monthlyPayment">-</div>
                    </div>
                    <div class="result-item">
                        <h3>‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡∏¢‡∏£‡∏ß‡∏°</h3>
                        <div class="value" id="totalInterest">-</div>
                    </div>
                    <div class="result-item">
                        <h3>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°</h3>
                        <div class="value" id="totalCost">-</div>
                    </div>
                </div>
                
                <div id="debtRatioAlert"></div>
                
                <div class="chart-container">
                    <canvas id="paymentChart"></canvas>
                </div>
            </div>
        </div>

        <div class="card full-width comparison-section">
            <h2>üè¶ ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</h2>
            <div class="bank-comparison" id="bankComparison"></div>
        </div>

        <div class="card full-width">
            <h2>üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ (12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏£‡∏Å)</h2>
            <div style="overflow-x: auto;">
                <table class="amortization-table">
                    <thead>
                        <tr>
                            <th width="10%">‡∏á‡∏ß‡∏î</th>
                            <th width="20%">‡∏¢‡∏≠‡∏î‡∏ú‡πà‡∏≠‡∏ô</th>
                            <th width="20%">‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô</th>
                            <th width="20%">‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡∏¢</th>
                            <th width="30%">‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                        </tr>
                    </thead>
                    <tbody id="amortizationTable">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://your-project.supabase.co'; // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ URL ‡∏à‡∏£‡∏¥‡∏á
        const SUPABASE_ANON_KEY = 'your-anon-key'; // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ API Key ‡∏à‡∏£‡∏¥‡∏á
        
        // ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ Supabase ‡∏à‡∏£‡∏¥‡∏á ‡∏à‡∏∞‡πÉ‡∏ä‡πâ Local Storage ‡πÅ‡∏ó‡∏ô
        const USE_SUPABASE = false; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô true ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ Supabase ‡∏à‡∏£‡∏¥‡∏á
        
        let supabase = null;
        let currentUser = null;
        let isLoginMode = true;

        // Mock API for bank rates (‡∏à‡∏≥‡∏•‡∏≠‡∏á API ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£)
        const mockBankAPI = {
            rates: [
                { name: '‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢', rate: 3.45, lastUpdate: new Date() },
                { name: '‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û', rate: 3.55, lastUpdate: new Date() },
                { name: '‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå', rate: 3.50, lastUpdate: new Date() },
                { name: '‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢', rate: 3.40, lastUpdate: new Date() },
                { name: '‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ó‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏ò‡∏ô‡∏ä‡∏≤‡∏ï', rate: 3.60, lastUpdate: new Date() }
            ],
            getRates: async function() {
                // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // ‡∏™‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡∏¢‡πÉ‡∏´‡∏°‡πà
                this.rates = this.rates.map(bank => ({
                    ...bank,
                    rate: (Math.random() * 1.5 + 2.8).toFixed(2), // ‡∏™‡∏∏‡πà‡∏°‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 2.8-4.3%
                    lastUpdate: new Date()
                }));
                
                return this.rates;

        const bankData = mockBankAPI.rates.map(bank => ({
            name: bank.name,
            rate: parseFloat(bank.rate),
            color: ['#4CAF50', '#2196F3', '#FF9800', '#9C27B0', '#F44336'][Math.floor(Math.random() * 5)]
        }));

        let paymentChart = null;

        // Initialize Supabase (‡∏´‡∏≤‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á)
        if (USE_SUPABASE && typeof supabase !== 'undefined') {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)} catch (error) {
                console.log('Supabase not available, using localStorage')}

        // Authentication Functions
        async function handleAuth() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô');
                return}

            try {
                if (USE_SUPABASE && supabase) {
                    if (isLoginMode) {
                        const { data, error } = await supabase.auth.signInWithPassword({
                            email: email,
                            password: password
                        });
                        if (error) throw error;
                        currentUser = data.user} else {
                        const { data, error } = await supabase.auth.signUp({
                            email: email,
                            password: password
                        });
                        if (error) throw error;
                        alert('‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ');
                        return} else {
                    // ‡πÉ‡∏ä‡πâ localStorage ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Demo
                    if (isLoginMode) {
                        const users = JSON.parse(localStorage.getItem('loanapp_users') || '[]');
                        const user = users.find(u => u.email === email && u.password === password);
                        if (!user) {
                            throw new Error('‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á')}
                        currentUser = { email: user.email, id: user.id }} else {
                        const users = JSON.parse(localStorage.getItem('loanapp_users') || '[]');
                        if (users.some(u => u.email === email)) {
                            throw new Error('‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß')}
                        const newUser = {
                            id: Date.now().toString(),
                            email: email,
                            password: password
                        };
                        users.push(newUser);
                        localStorage.setItem('loanapp_users', JSON.stringify(users));
                        alert('‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
                        toggleAuthMode();
                        return}

                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó UI ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                updateAuthUI(true);
                loadSavedCalculations()} catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message)}

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            const authButton = document.getElementById('authButton');
            const toggleButton = document.getElementById('toggleButton');
            
            if (isLoginMode) {
                authButton.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
                toggleButton.textContent = '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å'} else {
                authButton.textContent = '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å';
                toggleButton.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'}

        async function logout() {
            if (USE_SUPABASE && supabase) {
                await supabase.auth.signOut()}
            currentUser = null;
            updateAuthUI(false)}

        function updateAuthUI(loggedIn) {
            const loginForm = document.getElementById('loginForm');
            const userInfo = document.getElementById('userInfo');
            const saveBtn = document.getElementById('saveBtn');
            const savedSection = document.getElementById('savedCalculationsSection');

            if (loggedIn) {
                loginForm.style.display = 'none';
                userInfo.style.display = 'flex';
                document.getElementById('welcomeMessage').textContent = 
                    `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${currentUser.email}`;
                saveBtn.disabled = false;
                savedSection.style.display = 'block'} else {
                loginForm.style.display = 'flex';
                userInfo.style.display = 'none';
                saveBtn.disabled = true;
                savedSection.style.display = 'none'}

            // Clear form
            document.getElementById('email').value = '';
            document.getElementById('password').value = ''}

        // Data Management Functions
        async function saveLoanData() {
            if (!currentUser) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                return}

            const loanData = {
                user_id: currentUser.id,
                house_price: parseFloat(document.getElementById('housePrice').value),
                down_payment: parseFloat(document.getElementById('downPayment').value),
                interest_rate: parseFloat(document.getElementById('interestRate').value),
                loan_term: parseFloat(document.getElementById('loanTerm').value),
                monthly_income: parseFloat(document.getElementById('monthlyIncome').value),
                created_at: new Date().toISOString(),
                calculation_results: {
                    loan_amount: document.getElementById('loanAmount').textContent,
                    monthly_payment: document.getElementById('monthlyPayment').textContent,
                    total_interest: document.getElementById('totalInterest').textContent,
                    total_cost: document.getElementById('totalCost').textContent
                };

            try {
                if (USE_SUPABASE && supabase) {
                    const { data, error } = await supabase
                        .from('loan_calculations')
                        .insert([loanData]);
                    
                    if (error) throw error} else {
                    // ‡πÉ‡∏ä‡πâ localStorage
                    const savedData = JSON.parse(localStorage.getItem('loan_calculations') || '[]');
                    savedData.push({ ...loanData, id: Date.now() });
                    localStorage.setItem('loan_calculations', JSON.stringify(savedData))}

                alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                loadSavedCalculations()} catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message)}

        async function loadSavedCalculations() {
            if (!currentUser) return;

            try {
                let calculations = [];
                
                if (USE_SUPABASE && supabase) {
                    const { data, error } = await supabase
                        .from('loan_calculations')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('created_at', { ascending: false })
                        .limit(10);
                    
                    if (error) throw error;
                    calculations = data} else {
                    const savedData = JSON.parse(localStorage.getItem('loan_calculations') || '[]');
                    calculations = savedData
                        .filter(calc => calc.user_id === currentUser.id)
                        .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                        .slice(0, 10)}

                displaySavedCalculations(calculations)} catch (error) {
                console.error('Error loading calculations:', error)}

        function displaySavedCalculations(calculations) {
            const container = document.getElementById('savedCalculationsList');
            
            if (calculations.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</p>';
                return}

            container.innerHTML = calculations.map(calc => `
                <div class="calculation-item">
                    <div class="calculation-header">
                        <strong>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô: ${formatNumber(calc.house_price)} ‡∏ö‡∏≤‡∏ó</strong>
                        <div class="calculation-date">${new Date(calc.created_at).toLocaleDateString('th-TH')}</div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 14px;">
                        <div><strong>‡∏¢‡∏≠‡∏î‡∏Å‡∏π‡πâ:</strong> ${calc.calculation_results.loan_amount}</div>
                        <div><strong>‡∏ú‡πà‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</strong> ${calc.calculation_results.monthly_payment}</div>
                        <div><strong>‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡∏¢‡∏£‡∏ß‡∏°:</strong> ${calc.calculation_results.total_interest}</div>
                        <div><strong>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡∏¢:</strong> ${calc.interest_rate}%</div>
                    </div>
                    <button class="btn-secondary" onclick="loadCalculation(${calc.id || 'null'})" style="margin-top: 10px; padding: 5px 10px; font-size: 12px;">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ</button>
                </div>
            `).join('')}

        function loadCalculation(calcId) {
            const savedData = JSON.parse(localStorage.getItem('loan_calculations') || '[]');
            const calculation = savedData.find(calc => calc.id === calcId);
            
            if (calculation) {
                document.getElementById('housePrice').value = calculation.house_price;
                document.getElementById('downPayment').value = calculation.down_payment;
                document.getElementById('interestRate').value = calculation.interest_rate;
                document.getElementById('loanTerm').value = calculation.loan_term;
                document.getElementById('monthlyIncome').value = calculation.monthly_income;
                
                calculateLoan();
                
                // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
                document.querySelector('.main-content').scrollIntoView({ behavior: 'smooth' })}

        // API Integration Functions
        async function fetchLatestRates() {
            const statusDiv = document.getElementById('apiStatus');
            statusDiv.style.display = 'block';
            statusDiv.className = 'api-status status-loading';
            statusDiv.textContent = 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡∏¢‡∏à‡∏≤‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£...';

            try {
                const rates = await mockBankAPI.getRates();
                
                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£
                bankData.forEach((bank, index) => {
                    if (rates[index]) {
                        bank.rate = parseFloat(rates[index].rate)});

                statusDiv.className = 'api-status status-success';
                statusDiv.textContent = '‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!';
                
                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                const rateUpdateEl = document.getElementById('rateUpdateTime');
if(rateUpdateEl) rateUpdateEl.textContent = 
                    `‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${new Date().toLocaleString('th-TH')}`;

                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó
                calculateLoan();

                setTimeout(() => {
                    statusDiv.style.display = 'none'}, 3000)} catch (error) {
                statusDiv.className = 'api-status status-error';
                statusDiv.textContent = '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡∏¢';
                
                setTimeout(() => {
                    statusDiv.style.display = 'none'}, 5000)}

        // PDF Export Function
        async function exportToPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();

                // ‡πÄ‡∏û‡∏¥‡πà‡∏° Font ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                pdf.setFont('helvetica');
                pdf.setFontSize(16);

                // Header
                pdf.text('Loan Analysis Report', 20, 20);
                pdf.setFontSize(12);
                
                // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠
                const housePrice = document.getElementById('housePrice').value;
                const downPayment = document.getElementById('downPayment').value;
                const interestRate = document.getElementById('interestRate').value;
                const loanTerm = document.getElementById('loanTerm').value;
                const monthlyIncome = document.getElementById('monthlyIncome').value;

                let yPos = 40;
                pdf.text('Loan Information:', 20, yPos);
                yPos += 10;
                pdf.text(`House Price: ${formatNumber(housePrice)} Baht`, 30, yPos);
                yPos += 8;
                pdf.text(`Down Payment: ${downPayment}%`, 30, yPos);
                yPos += 8;
                pdf.text(`Interest Rate: ${interestRate}%`, 30, yPos);
                yPos += 8;
                pdf.text(`Loan Term: ${loanTerm} years`, 30, yPos);
                yPos += 8;
                pdf.text(`Monthly Income: ${formatNumber(monthlyIncome)} Baht`, 30, yPos);

                // ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
                yPos += 20;
                pdf.text('Calculation Results:', 20, yPos);
                yPos += 10;
                pdf.text(`Loan Amount: ${document.getElementById('loanAmount').textContent}`, 30, yPos);
                yPos += 8;
                pdf.text(`Monthly Payment: ${document.getElementById('monthlyPayment').textContent}`, 30, yPos);
                yPos += 8;
                pdf.text(`Total Interest: ${document.getElementById('totalInterest').textContent}`, 30, yPos);
                yPos += 8;
                pdf.text(`Total Cost: ${document.getElementById('totalCost').textContent}`, 30, yPos);

                // ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£
                yPos += 20;
                pdf.text('Bank Comparison:', 20, yPos);
                yPos += 10;

                const loanAmount = parseFloat(housePrice) * (1 - parseFloat(downPayment) / 100);
                bankData.forEach(bank => {
                    const monthlyPayment = calculateMonthlyPayment(loanAmount, bank.rate, parseFloat(loanTerm));
                    pdf.text(`${bank.name}: ${bank.rate}% - ${formatNumber(monthlyPayment)} Baht/month`, 30, yPos);
                    yPos += 8});

                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå
                const fileName = `loan-analysis-${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(fileName)} catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á PDF: ' + error.message)}

        function formatNumber(num) {
            return new Intl.NumberFormat('th-TH').format(Math.round(num))}

        function calculateMonthlyPayment(principal, rate, term) {
            const monthlyRate = rate / 100 / 12;
            const numPayments = term * 12;
            
            if (monthlyRate === 0) {
                return principal / numPayments}
            
            return (principal * monthlyRate * Math.pow(1 + monthlyRate, numPayments)) /
                   (Math.pow(1 + monthlyRate, numPayments) - 1)}

        function calculateLoan() {
            const housePrice = parseFloat(document.getElementById('housePrice').value) || 0;
            const downPaymentPercent = parseFloat(document.getElementById('downPayment').value) || 0;
            const interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
            const loanTerm = parseFloat(document.getElementById('loanTerm').value) || 30;
            const monthlyIncome = parseFloat(document.getElementById('monthlyIncome').value) || 0;

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏Å‡∏π‡πâ‡∏¢‡∏∑‡∏°
            const downPaymentAmount = housePrice * (downPaymentPercent / 100);
            const loanAmount = housePrice - downPaymentAmount;

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏ú‡πà‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
            const monthlyPayment = calculateMonthlyPayment(loanAmount, interestRate, loanTerm);
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡∏¢‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°
            const totalPayments = monthlyPayment * loanTerm * 12;
            const totalInterest = totalPayments - loanAmount;
            const totalCost = housePrice + totalInterest;

            // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
            document.getElementById('loanAmount').textContent = formatNumber(loanAmount) + ' ‡∏ö‡∏≤‡∏ó';
            document.getElementById('monthlyPayment').textContent = formatNumber(monthlyPayment) + ' ‡∏ö‡∏≤‡∏ó';
            document.getElementById('totalInterest').textContent = formatNumber(totalInterest) + ' ‡∏ö‡∏≤‡∏ó';
            document.getElementById('totalCost').textContent = formatNumber(totalCost) + ' ‡∏ö‡∏≤‡∏ó';

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Debt-to-Income Ratio
            const debtRatio = (monthlyPayment / monthlyIncome) * 100;
            showDebtRatioAlert(debtRatio);

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏´
            createPaymentChart(loanAmount, totalInterest);

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ
            createAmortizationTable(loanAmount, interestRate, loanTerm, monthlyPayment);

            // ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£
            compareBanks(loanAmount, loanTerm)}

        function showDebtRatioAlert(ratio) {
            const alertDiv = document.getElementById('debtRatioAlert');
            let alertClass = '';
            let message = '';

            if (ratio <= 30) {
                alertClass = 'success';
                message = `‚úÖ ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏´‡∏ô‡∏µ‡πâ‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ: ${ratio.toFixed(1)}% - ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ó‡∏µ‡πà‡∏î‡∏µ`} else if (ratio <= 40) {
                alertClass = 'warning';
                message = `‚ö†Ô∏è ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏´‡∏ô‡∏µ‡πâ‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ: ${ratio.toFixed(1)}% - ‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏°‡∏±‡∏î‡∏£‡∏∞‡∏ß‡∏±‡∏á`} else {
                alertClass = 'warning';
                message = `üö® ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏´‡∏ô‡∏µ‡πâ‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ: ${ratio.toFixed(1)}% - ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏•‡∏î‡∏¢‡∏≠‡∏î‡∏Å‡∏π‡πâ`}

            alertDiv.innerHTML = `<div class="${alertClass}">${message}</div>`}

        function createPaymentChart(principal, interest) {
            const ctx = document.getElementById('paymentChart').getContext('2d');
            
            if (paymentChart) {
                paymentChart.destroy()}

            paymentChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô', '‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡∏¢'],
                    datasets: [{
                        data: [principal, interest],
                        backgroundColor: ['#667eea', '#f093fb'],
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + formatNumber(context.raw) + ' ‡∏ö‡∏≤‡∏ó'}
                        }
                })}

        function createAmortizationTable(loanAmount, interestRate, loanTerm, monthlyPayment) {
            const tbody = document.getElementById('amortizationTable');
            tbody.innerHTML = '';

            let remainingBalance = loanAmount;
            const monthlyRate = interestRate / 100 / 12;

            // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏û‡∏µ‡∏¢‡∏á 12 ‡∏á‡∏ß‡∏î‡πÅ‡∏£‡∏Å
            for (let month = 1; month <= 12; month++) {
                const interestPayment = remainingBalance * monthlyRate;
                const principalPayment = monthlyPayment - interestPayment;
                remainingBalance -= principalPayment;

                const row = tbody.insertRow();
                row.insertCell(0).textContent = month;
                row.insertCell(1).textContent = formatNumber(monthlyPayment);
                row.insertCell(2).textContent = formatNumber(principalPayment);
                row.insertCell(3).textContent = formatNumber(interestPayment);
                row.insertCell(4).textContent = formatNumber(Math.max(0, remainingBalance));

                // ‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏µ‡πÅ‡∏ñ‡∏ß
                if (month % 2 === 0) {
                    row.style.backgroundColor = '#f8f9fa'}
        }

        function compareBanks(loanAmount, loanTerm) {
            const container = document.getElementById('bankComparison');
            if (!container) return;
            
            try {
                container.innerHTML = '';

                bankData.forEach(bank => {
                    const monthlyPayment = calculateMonthlyPayment(loanAmount, bank.rate, loanTerm);
                    const totalPayments = monthlyPayment * loanTerm * 12;
                    const totalInterest = totalPayments - loanAmount;

                    const bankCard = document.createElement('div');
                    bankCard.className = 'bank-card';
                    bankCard.style.borderLeftColor = bank.color;
                    
                    bankCard.innerHTML = `
                        <div class="bank-name">${bank.name}</div>
                        <div><strong>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡∏¢:</strong> ${bank.rate}%</div>
                        <div><strong>‡∏ú‡πà‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</strong> ${formatNumber(monthlyPayment)} ‡∏ö‡∏≤‡∏ó</div>
                        <div><strong>‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡∏¢‡∏£‡∏ß‡∏°:</strong> ${formatNumber(totalInterest)} ‡∏ö‡∏≤‡∏ó</div>
                    `;

                    container.appendChild(bankCard)})} catch (error) {
                console.error('Error comparing banks:', error)}

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
        window.addEventListener('load', function() {
            calculateLoan();
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö session ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
            checkExistingSession();
            
            // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
            const rateUpdateEl = document.getElementById('rateUpdateTime');
if(rateUpdateEl) rateUpdateEl.textContent = 
                `‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${new Date().toLocaleString('th-TH')}`});

        async function checkExistingSession() {
            if (USE_SUPABASE && supabase) {
                const { data: { user } = await supabase.auth.getUser();
                if (user) {
                    currentUser = user;
                    updateAuthUI(true);
                    loadSavedCalculations()} else {
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö localStorage session
                const savedSession = localStorage.getItem('loanapp_session');
                if (savedSession) {
                    currentUser = JSON.parse(savedSession);
                    updateAuthUI(true);
                    loadSavedCalculations()}
        }

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        document.querySelectorAll('input, select').forEach(element => {
            element.addEventListener('change', calculateLoan);
            element.addEventListener('input', calculateLoan)});

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° Enter key support ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö login form
const emailInput = document.getElementById('email');
if (emailInput) {
  emailInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') handleAuth();
  });
}

const passwordInput = document.getElementById('password');
if (passwordInput) {
  passwordInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') handleAuth();
  });
})}
            if (e.key === 'Enter') handleAuth()});

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å session ‡πÉ‡∏ô localStorage (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö demo)
        function saveSession() {
            if (!USE_SUPABASE && currentUser) {
                localStorage.setItem('loanapp_session', JSON.stringify(currentUser))}

        // ‡∏•‡∏ö session
        function clearSession() {
            localStorage.removeItem('loanapp_session')}

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô updateAuthUI ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ session - ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ
        async function deleteCalculation(calcId) {
            if (!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;

            try {
                if (USE_SUPABASE && supabase) {
                    const { error } = await supabase
                        .from('loan_calculations')
                        .delete()
                        .eq('id', calcId);
                    if (error) throw error} else {
                    const savedData = JSON.parse(localStorage.getItem('loan_calculations') || '[]');
                    const filteredData = savedData.filter(calc => calc.id !== calcId);
                    localStorage.setItem('loan_calculations', JSON.stringify(filteredData))}

                loadSavedCalculations();
                alert('‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à')} catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message)}

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô displaySavedCalculations ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö
        const originalDisplaySavedCalculations = displaySavedCalculations;
        displaySavedCalculations = function(calculations) {
            const container = document.getElementById('savedCalculationsList');
            
            if (calculations.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</p>';
                return}

            container.innerHTML = calculations.map(calc => `
                <div class="calculation-item">
                    <div class="calculation-header">
                        <strong>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô: ${formatNumber(calc.house_price)} ‡∏ö‡∏≤‡∏ó</strong>
                        <div class="calculation-date">${new Date(calc.created_at).toLocaleDateString('th-TH')}</div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 14px;">
                        <div><strong>‡∏¢‡∏≠‡∏î‡∏Å‡∏π‡πâ:</strong> ${calc.calculation_results.loan_amount}</div>
                        <div><strong>‡∏ú‡πà‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</strong> ${calc.calculation_results.monthly_payment}</div>
                        <div><strong>‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡∏¢‡∏£‡∏ß‡∏°:</strong> ${calc.calculation_results.total_interest}</div>
                        <div><strong>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡∏¢:</strong> ${calc.interest_rate}%</div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button class="btn-secondary" onclick="loadCalculation(${calc.id || 'null'})" style="padding: 5px 10px; font-size: 12px; flex: 1;">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                        <button class="btn-danger" onclick="deleteCalculation(${calc.id || 'null'})" style="padding: 5px 10px; font-size: 12px; flex: 1;">‡∏•‡∏ö</button>
                    </div>
                </div>
            `).join('')};

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô JSON
        async function exportAllData() {
            if (!currentUser) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô');
                return}

            try {
                let calculations = [];
                
                if (USE_SUPABASE && supabase) {
                    const { data, error } = await supabase
                        .from('loan_calculations')
                        .select('*')
                        .eq('user_id', currentUser.id);
                    if (error) throw error;
                    calculations = data} else {
                    const savedData = JSON.parse(localStorage.getItem('loan_calculations') || '[]');
                    calculations = savedData.filter(calc => calc.user_id === currentUser.id)}

                const dataStr = JSON.stringify(calculations, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `loan-calculations-${new Date().toISOString().split('T')[0]}.json`;
                link.click()} catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message)}

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° Export ‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ
        const originalLoadSavedCalculations = loadSavedCalculations;
        loadSavedCalculations = async function() {
            await originalLoadSavedCalculations();
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° Export ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            const savedSection = document.getElementById('savedCalculationsSection');
            if (savedSection.style.display !== 'none') {
                const existingButton = savedSection.querySelector('.export-all-button');
                if (!existingButton) {
                    const exportButton = document.createElement('button');
                    exportButton.className = 'btn-secondary export-all-button';
                    exportButton.onclick = exportAllData;
                    exportButton.textContent = 'üì¶ Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
                    exportButton.style.marginBottom = '20px';
                    
                    savedSection.insertBefore(exportButton, document.getElementById('savedCalculationsList'))}
        };

        console.log('üè† Loan Analysis App Loaded Successfully!');
        console.log('Features: PDF Export, Data Management, Supabase Integration');
        console.log('üîó Connected to Supabase:', SUPABASE_URL);
        
        if (!USE_SUPABASE) {
            console.log('üìù Fallback Mode: Using localStorage');
            console.log('üí° Supabase connection failed, check console for errors')} else {
            console.log('üéØ Production Mode: Using Supabase for data storage');
            console.log('üìä Database ready for loan calculations')}
    </script>

<!-- ==== Placeholders Added for Auth & Rate Update ==== -->
<form id="loginForm" style="display:none;">
  <input type="text" id="email" placeholder="Email" autocomplete="username">
  <input type="password" id="password" placeholder="Password" autocomplete="current-password">
  <button id="authButton">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
  <button id="toggleButton">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
</form>
<div id="userInfo" style="display:none;">
  <span id="welcomeMessage"></span>
  <button onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
</div>
<div id="savedCalculationsSection" style="display:none;">
  <div id="savedCalculationsList"></div>
  <button id="saveBtn" disabled>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
</div>
<div id="rateUpdateTime" style="margin-top:10px;color:#fff;font-size:0.9em;"></div>

</body>
</html>
